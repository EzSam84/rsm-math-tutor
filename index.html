<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSM Math Quest - Advanced Edition</title>
    <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --accent: #8b5cf6;
            --accent-light: #a78bfa;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
        }

        .header-left h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.025em;
        }

        .header-left p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .header-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-item:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 1.25rem;
        }

        .stat-value {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .login-container {
            padding: 80px 40px;
            text-align: center;
            background: linear-gradient(to bottom, var(--bg-primary), var(--bg-secondary));
        }

        .login-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.025em;
        }

        .login-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 48px;
            font-weight: 500;
        }

        .login-form {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 36px;
            max-width: 420px;
            margin: 0 auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .role-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 4px;
            gap: 4px;
            margin-bottom: 28px;
        }

        .role-toggle button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .role-toggle button.active {
            background: var(--bg-primary);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .login-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .login-links {
            margin-top: 28px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .login-links p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .login-links-row {
            display: flex;
            gap: 16px;
        }

        .link-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            font-family: inherit;
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        .link-btn:hover {
            color: var(--primary-dark);
        }

        .pending-card {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 48px 36px;
            max-width: 480px;
            margin: 0 auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            text-align: center;
        }

        .pending-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .approve-reject-row {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .btn-approve {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }

        .btn-approve:hover { opacity: 0.9; }

        .btn-reject {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }

        .btn-reject:hover { opacity: 0.8; }

        .pending-approval-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .pending-approval-card .student-info {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
            background: var(--bg-secondary);
            min-height: 500px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }

        .btn-hint {
            background: linear-gradient(135deg, var(--warning), #f97316);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn-hint:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-tutor {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn-tutor:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .topic-card {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 36px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .topic-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .topic-icon {
            font-size: 3.5rem;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .topic-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .topic-card p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .problem-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .problem-card {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .problem-text {
            font-size: 1.5rem;
            margin-bottom: 32px;
            line-height: 1.6;
            color: var(--text-primary);
            font-weight: 500;
        }

        .answer-input {
            width: 100%;
            padding: 16px;
            font-size: 1.125rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            font-family: inherit;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            background: var(--bg-primary);
        }

        .feedback {
            padding: 20px 24px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 1.125rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .feedback.correct {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 2px solid #10b981;
        }

        .feedback.incorrect {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .hint-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid var(--warning);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .visual-aid {
            background: var(--bg-tertiary);
            padding: 24px;
            border-radius: 16px;
            margin: 24px 0;
            text-align: center;
            border: 1px solid var(--border);
        }

        .visual-aid h3 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 1.125rem;
        }

        .visual-aid canvas {
            max-width: 100%;
            height: auto;
            background: white;
            border-radius: 12px;
            padding: 16px;
        }

        .chat-container {
            background: var(--bg-primary);
            border: 2px solid var(--primary);
            border-radius: 16px;
            margin-top: 24px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 16px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-secondary);
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.5;
        }

        .chat-message.user {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            margin-left: auto;
            box-shadow: var(--shadow-sm);
        }

        .chat-message.assistant {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .chat-send {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-send:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            padding: 12px 16px;
        }

        .typing-dots {
            display: flex;
            gap: 6px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .parent-dashboard {
            padding: 32px;
        }

        .student-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .student-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .stat-box {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-box h4 {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-box p {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.875rem;
            margin-bottom: 16px;
            letter-spacing: -0.025em;
        }

        .form-card {
            background: white;
            border-radius: 15px;
            padding: 24px;
            margin-bottom: 24px;
            border: 2px solid var(--primary);
        }

        .form-card h3 {
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            margin-top: 14px;
        }

        .avatar-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0 20px;
        }

        .avatar-option {
            font-size: 1.8em;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .avatar-option:hover {
            background: var(--bg-tertiary);
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.08);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Skill tree ‚Äî parent dashboard */
        .skill-tree-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .skill-domain-block {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .skill-domain-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .skill-node {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 7px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: default;
        }

        .skill-not-started { background: var(--bg-secondary); color: var(--text-secondary); }
        .skill-learning    { background: #fef9c3; color: #854d0e; }
        .skill-practicing  { background: #dbeafe; color: #1e40af; }
        .skill-mastered    { background: #dcfce7; color: #166534; }
        .skill-struggling  { background: #fee2e2; color: #991b1b; }

        .skill-node-name  { font-weight: 500; }
        .skill-node-count { font-weight: 700; font-size: 0.8rem; opacity: 0.85; }

        /* Exit ticket bridge ‚Äî mini-tutorial card */
        .bridge-card {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 36px;
            margin-top: 28px;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--accent);
        }

        .bridge-badge {
            display: inline-block;
            background: var(--accent);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 16px;
        }

        .bridge-card h2 {
            font-size: 1.75rem;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .bridge-card > p {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .bridge-example {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid var(--border);
        }

        .bridge-problem {
            font-size: 1.0625rem;
            font-style: italic;
            color: var(--text-primary);
            margin-bottom: 16px;
            font-weight: 500;
        }

        .bridge-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
        }

        .bridge-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 0.9375rem;
            color: var(--text-primary);
        }

        .bridge-step-num {
            background: var(--accent);
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .bridge-answer {
            font-weight: 700;
            color: var(--secondary-dark);
            font-size: 1rem;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .bridge-actions {
            display: flex;
            gap: 14px;
            margin-top: 28px;
            flex-wrap: wrap;
        }

        /* Grade picker ‚Äî child registration */
        .grade-picker {
            display: flex;
            gap: 8px;
            margin: 8px 0 20px;
        }

        .grade-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .grade-btn.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.08);
            color: var(--primary);
        }

        /* Grade badge on lesson cards */
        .grade-badge {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 20px;
            margin-top: 6px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const AVATARS = [
            { emoji: 'üë¶', name: 'Hero Boy' },
            { emoji: 'üëß', name: 'Magic Girl' },
            { emoji: 'üßë‚ÄçüöÄ', name: 'Space Cadet' },
            { emoji: 'ü•∑', name: 'Ninja' },
            { emoji: 'ü¶∏‚Äç‚ôÇÔ∏è', name: 'Super Hero' },
            { emoji: 'ü¶∏‚Äç‚ôÄÔ∏è', name: 'Wonder Girl' },
            { emoji: 'üßô‚Äç‚ôÇÔ∏è', name: 'Wizard' },
            { emoji: 'üßô‚Äç‚ôÄÔ∏è', name: 'Sorceress' },
            { emoji: 'ü§ñ', name: 'Robot' },
            { emoji: 'üëæ', name: 'Pixel Hero' },
        ];

        const ACHIEVEMENTS = [
            { id: 'first_problem', name: 'First Steps', icon: 'üéØ', requirement: { problemsSolved: 1 }, xp: 50 },
            { id: 'streak_3', name: '3-Day Streak', icon: 'üî•', requirement: { streak: 3 }, xp: 100 },
            { id: 'problems_10', name: 'Problem Solver', icon: 'üß†', requirement: { problemsSolved: 10 }, xp: 150 },
            { id: 'problems_50', name: 'Math Champion', icon: 'üèÜ', requirement: { problemsSolved: 50 }, xp: 500 },
        ];

        const LESSONS = {
            'algebra-lesson-1': {
                title: 'Introduction to Linear Equations',
                topic: 'algebra',
                // The structural insight students should discover during the discovery phase
                ruleToDiscover: 'To isolate x in an equation, apply the inverse (opposite) operation to both sides ‚Äî if something is added to x, subtract it from both sides; if x is multiplied by a number, divide both sides by that number.',
                warmup: [
                    { question: "What is 5 + x when x = 3?", answer: "8", hint: "Replace x with 3", explanation: "5 + 3 = 8", xp: 5 },
                    { question: "If y = 7, what is 2 * y?", answer: "14", hint: "Multiply 2 by 7", explanation: "2 * 7 = 14", xp: 5 },
                    { question: "What is 3 * x when x = 4?", answer: "12", hint: "Replace x with 4, then multiply", explanation: "3 * 4 = 12", xp: 5 },
                    { question: "If a = 5, what is 3a - 2?", answer: "13", hint: "Multiply 3 by 5, then subtract 2", explanation: "3 * 5 - 2 = 15 - 2 = 13", xp: 5 },
                ],
                discovery: [
                    { question: "x + 3 = 10. What is x?", answer: "7", hint: "What number plus 3 equals 10?", explanation: "10 - 3 = 7", xp: 10 },
                    { question: "x + 5 = 12. What is x?", answer: "7", hint: "What do you notice is the same as the previous problem?", explanation: "12 - 5 = 7", xp: 10 },
                    { question: "x + 8 = 15. What is x?", answer: "7", hint: "What pattern do you see?", explanation: "15 - 8 = 7", xp: 10 },
                    { question: "Now try: 2x = 10. What is x?", answer: "5", hint: "What number times 2 equals 10?", explanation: "10 / 2 = 5", xp: 10 },
                    { question: "Solve: 3x = 21", answer: "7", hint: "What operation undoes multiplication?", explanation: "21 / 3 = 7", xp: 10 },
                    { question: "x + 12 = 20. What is x?", answer: "8", hint: "What number plus 12 equals 20?", explanation: "20 - 12 = 8", xp: 10 },
                    { question: "x - 3 = 9. What is x?", answer: "12", hint: "Add 3 to both sides", explanation: "x = 9 + 3 = 12", xp: 10 },
                    { question: "5x = 35. What is x?", answer: "7", hint: "Divide both sides by 5", explanation: "35 / 5 = 7", xp: 10 },
                    { question: "4x = 36. What is x?", answer: "9", hint: "What operation undoes multiplication?", explanation: "36 / 4 = 9", xp: 10 },
                    { question: "x / 2 = 6. What is x?", answer: "12", hint: "Multiply both sides by 2", explanation: "x = 6 * 2 = 12", xp: 10 },
                ],
                application: [
                    { question: "Solve for x: 2x + 5 = 15", answer: "5", hint: "First subtract 5 from both sides", explanation: "2x + 5 = 15 ‚Üí 2x = 10 ‚Üí x = 5", xp: 15 },
                    { question: "What is x if 3x - 7 = 14?", answer: "7", hint: "Add 7 to both sides first", explanation: "3x - 7 = 14 ‚Üí 3x = 21 ‚Üí x = 7", xp: 15 },
                    { question: "Solve: 4x - 8 = 12", answer: "5", hint: "Add 8, then divide by 4", explanation: "4x - 8 = 12 ‚Üí 4x = 20 ‚Üí x = 5", xp: 15 },
                    { question: "If 5x + 3 = 28, what is x?", answer: "5", hint: "What's your first step?", explanation: "5x + 3 = 28 ‚Üí 5x = 25 ‚Üí x = 5", xp: 15 },
                    { question: "Solve: 3x + 4 = 19", answer: "5", hint: "Subtract 4 first, then divide by 3", explanation: "3x + 4 = 19 ‚Üí 3x = 15 ‚Üí x = 5", xp: 15 },
                    { question: "Solve: 6x - 12 = 18", answer: "5", hint: "Add 12 to both sides, then divide by 6", explanation: "6x - 12 = 18 ‚Üí 6x = 30 ‚Üí x = 5", xp: 15 },
                    { question: "Solve: 2x + 9 = 23", answer: "7", hint: "Subtract 9 from both sides first", explanation: "2x + 9 = 23 ‚Üí 2x = 14 ‚Üí x = 7", xp: 15 },
                    { question: "Solve: 7x - 14 = 35", answer: "7", hint: "Add 14 to both sides, then divide", explanation: "7x - 14 = 35 ‚Üí 7x = 49 ‚Üí x = 7", xp: 15 },
                ],
                exitTicket: [
                    { question: "Solve: 6x - 9 = 15", answer: "4", hint: "Use the same steps you learned", explanation: "6x - 9 = 15 ‚Üí 6x = 24 ‚Üí x = 4", xp: 20 },
                    { question: "A number multiplied by 7, then decreased by 5, equals 30. What is the number?", answer: "5", hint: "Write this as 7x - 5 = 30", explanation: "7x - 5 = 30 ‚Üí 7x = 35 ‚Üí x = 5", xp: 25 },
                    { question: "Solve: 8x + 5 = 53", answer: "6", hint: "What's your first step?", explanation: "8x + 5 = 53 ‚Üí 8x = 48 ‚Üí x = 6", xp: 20 },
                    { question: "Twice a number minus 9 equals 11. What is the number?", answer: "10", hint: "Write this as 2x - 9 = 11", explanation: "2x - 9 = 11 ‚Üí 2x = 20 ‚Üí x = 10", xp: 25 },
                ],
                exitTicketBridge: {
                    concept: 'Word Problems',
                    explanation: "The exit ticket uses word problems ‚Äî real situations described in words that you translate into an equation, then solve. The steps are the same ones you just practiced!",
                    example: {
                        problem: '"A number times 4, then minus 3, equals 21. What is the number?"',
                        steps: ['Write it as an equation: 4x ‚àí 3 = 21', 'Add 3 to both sides: 4x = 24', 'Divide both sides by 4: x = 6'],
                        answer: 'x = 6',
                    },
                },
            },
            'geometry-lesson-1': {
                title: 'Perimeter and Area of Rectangles',
                topic: 'geometry',
                ruleToDiscover: 'Adding all four sides gives perimeter (since opposite sides of a rectangle are equal, this equals 2√ólength + 2√ówidth). Multiplying length √ó width gives area. These are two different operations because perimeter measures distance around the outside and area measures the space inside.',
                warmup: [
                    { question: "How many sides does a rectangle have?", answer: "4", hint: "Count them: top, bottom, left, right", explanation: "A rectangle has 4 sides", xp: 5 },
                    { question: "Opposite sides of a rectangle are equal. If one length is 7 cm, what is the length of the opposite side?", answer: "7", hint: "Opposite sides always match in a rectangle", explanation: "Opposite sides of a rectangle are equal, so the other length is also 7 cm", xp: 5 },
                    { question: "What do we call the total distance around the outside of a shape?", answer: "perimeter", hint: "Think about walking all the way around the shape", explanation: "The perimeter is the total distance around the outside of a shape", xp: 5 },
                    { question: "What do we call the amount of space covered inside a rectangle?", answer: "area", hint: "Think about the surface filled inside the shape", explanation: "The area measures the space inside a shape", xp: 5 },
                ],
                discovery: [
                    { question: "A rectangle has length 4 and width 2. Add all four sides. What do you get?", answer: "12", hint: "4 + 2 + 4 + 2 = ?", explanation: "4 + 2 + 4 + 2 = 12 (this is the perimeter)", xp: 10 },
                    { question: "Same rectangle (length 4, width 2). What is length * width?", answer: "8", hint: "Multiply 4 by 2", explanation: "4 * 2 = 8 (this is the area)", xp: 10 },
                    { question: "New rectangle: length 6, width 3. Find perimeter (add all sides)", answer: "18", hint: "6 + 3 + 6 + 3", explanation: "6+3+6+3 = 18", xp: 10 },
                    { question: "Same rectangle (6 by 3). Find area (length * width)", answer: "18", hint: "What is 6 * 3?", explanation: "6 * 3 = 18", xp: 10 },
                    { question: "A rectangle has length 5 and width 3. Add all four sides.", answer: "16", hint: "5 + 3 + 5 + 3 = ?", explanation: "5+3+5+3 = 16 (this is the perimeter)", xp: 10 },
                    { question: "Same rectangle (length 5, width 3). What is length * width?", answer: "15", hint: "Multiply 5 by 3", explanation: "5 * 3 = 15 (this is the area)", xp: 10 },
                    { question: "New rectangle: length 9, width 4. Find perimeter.", answer: "26", hint: "9 + 4 + 9 + 4 = ?", explanation: "9+4+9+4 = 26", xp: 10 },
                    { question: "Same rectangle (9 by 4). Find area (length * width)", answer: "36", hint: "What is 9 * 4?", explanation: "9 * 4 = 36", xp: 10 },
                ],
                application: [
                    { question: "Rectangle with length 8 m and width 5 m. What is its area?", answer: "40", hint: "Area = length * width", explanation: "A = 8 * 5 = 40 m¬≤", xp: 12 },
                    { question: "What is the perimeter of a rectangle with length 12 cm and width 7 cm?", answer: "38", hint: "Add all four sides, or use 2(length + width)", explanation: "P = 2(12 + 7) = 2(19) = 38 cm", xp: 15 },
                    { question: "A square has a side of 6 cm. What is its perimeter?", answer: "24", hint: "All four sides are equal in a square", explanation: "P = 4 * 6 = 24 cm", xp: 10 },
                    { question: "A square has a side of 9 m. What is its area?", answer: "81", hint: "Area = side * side", explanation: "A = 9 * 9 = 81 m¬≤", xp: 12 },
                    { question: "Rectangle with length 10 m and width 6 m. What is its perimeter?", answer: "32", hint: "Use 2(length + width)", explanation: "P = 2(10 + 6) = 2(16) = 32 m", xp: 12 },
                    { question: "Rectangle with length 15 cm and width 4 cm. What is its area?", answer: "60", hint: "Area = length * width", explanation: "A = 15 * 4 = 60 cm¬≤", xp: 15 },
                    { question: "A square has a side of 11 m. What is its area?", answer: "121", hint: "Area = side * side", explanation: "A = 11 * 11 = 121 m¬≤", xp: 12 },
                    { question: "What is the perimeter of a rectangle with length 13 cm and width 3 cm?", answer: "32", hint: "Add all four sides, or use 2(length + width)", explanation: "P = 2(13 + 3) = 2(16) = 32 cm", xp: 15 },
                ],
                exitTicket: [
                    { question: "A rectangle has perimeter 30 cm. Its length is 10 cm. What is its width?", answer: "5", hint: "If perimeter is 30, then 2(length + width) = 30", explanation: "2(10 + w) = 30 ‚Üí 10 + w = 15 ‚Üí w = 5 cm", xp: 20 },
                    { question: "A rectangular garden has area 48 m¬≤ and width 6 m. What is its length?", answer: "8", hint: "Area = length * width, so length = area / width", explanation: "48 / 6 = 8 m", xp: 20 },
                    { question: "A square has a perimeter of 36 cm. What is the length of one side?", answer: "9", hint: "Perimeter = 4 * side, so side = perimeter / 4", explanation: "36 / 4 = 9 cm", xp: 20 },
                    { question: "A rectangle has area 72 m¬≤ and length 9 m. What is its width?", answer: "8", hint: "Area = length * width, so width = area / length", explanation: "72 / 9 = 8 m", xp: 20 },
                ],
                exitTicketBridge: {
                    concept: 'Working Backwards',
                    explanation: "Instead of finding perimeter or area from given dimensions, these problems give you the result and ask for a missing side. Use the same formulas ‚Äî just rearrange them.",
                    example: {
                        problem: '"A rectangle has a perimeter of 24 cm and a length of 8 cm. What is its width?"',
                        steps: ['Use the formula: 2(length + width) = perimeter', 'Plug in: 2(8 + w) = 24 ‚Üí 8 + w = 12', 'Subtract 8: w = 4 cm'],
                        answer: 'Width = 4 cm',
                    },
                },
            },
            'fractions-lesson-1': {
                title: 'Adding Fractions with Same Denominator',
                topic: 'fractions',
                ruleToDiscover: 'When fractions share the same denominator, add or subtract only the numerators (top numbers) and keep the denominator unchanged. The denominator represents the size of each piece ‚Äî you are just counting how many same-sized pieces you have, not changing what size the pieces are.',
                warmup: [
                    { question: "How many halves make a whole?", answer: "2", hint: "2/2 = 1 whole", explanation: "Two halves = 1", xp: 5 },
                    { question: "How many fourths make a whole?", answer: "4", hint: "4/4 = 1 whole", explanation: "Four fourths = 1", xp: 5 },
                    { question: "What fraction of a shape is shaded if 3 out of 5 equal parts are colored?", answer: "3/5", hint: "The shaded parts go on top, the total parts go on the bottom", explanation: "3 shaded out of 5 total = 3/5", xp: 5 },
                    { question: "How many thirds make a whole?", answer: "3", hint: "3/3 = 1 whole", explanation: "Three thirds = 1", xp: 5 },
                ],
                discovery: [
                    { question: "Add: 1/5 + 1/5", answer: "2/5", hint: "How many fifths do you have total?", explanation: "1 fifth + 1 fifth = 2 fifths", xp: 10 },
                    { question: "Add: 1/5 + 2/5", answer: "3/5", hint: "Count the fifths: 1 + 2 = ?", explanation: "1/5 + 2/5 = 3/5", xp: 10 },
                    { question: "What is 2/7 + 3/7?", answer: "5/7", hint: "Add the numerators (top numbers), keep denominator", explanation: "2/7 + 3/7 = 5/7", xp: 10 },
                    { question: "Add: 1/4 + 1/4", answer: "2/4", alternateAnswers: ["1/2"], hint: "Add numerators, keep the 4", explanation: "1/4 + 1/4 = 2/4 = 1/2", xp: 10 },
                    { question: "Add: 2/6 + 3/6", answer: "5/6", hint: "Add the numerators, keep the 6", explanation: "2/6 + 3/6 = 5/6", xp: 10 },
                    { question: "What is 3/8 + 4/8?", answer: "7/8", hint: "Add the top numbers, keep the denominator", explanation: "3/8 + 4/8 = 7/8", xp: 10 },
                    { question: "Subtract: 4/5 - 2/5", answer: "2/5", hint: "Subtract numerators, keep denominator", explanation: "4/5 - 2/5 = 2/5", xp: 10 },
                    { question: "Add: 2/10 + 5/10", answer: "7/10", hint: "Add the numerators, denominator stays the same", explanation: "2/10 + 5/10 = 7/10", xp: 10 },
                ],
                application: [
                    { question: "What is 2/5 + 1/5?", answer: "3/5", hint: "Same denominators, just add numerators", explanation: "2/5 + 1/5 = 3/5", xp: 10 },
                    { question: "Add: 3/8 + 2/8", answer: "5/8", hint: "Keep the denominator 8", explanation: "3/8 + 2/8 = 5/8", xp: 12 },
                    { question: "Subtract: 5/8 - 3/8", answer: "2/8", alternateAnswers: ["1/4"], hint: "Subtract numerators, keep denominator", explanation: "5/8 - 3/8 = 2/8 = 1/4", xp: 12 },
                    { question: "What is 4/6 + 1/6?", answer: "5/6", hint: "Add the top numbers", explanation: "4/6 + 1/6 = 5/6", xp: 12 },
                    { question: "What is 3/7 + 3/7?", answer: "6/7", hint: "Add numerators, keep denominator 7", explanation: "3/7 + 3/7 = 6/7", xp: 12 },
                    { question: "Add: 4/9 + 4/9", answer: "8/9", hint: "Same denominators, just add numerators", explanation: "4/9 + 4/9 = 8/9", xp: 12 },
                    { question: "Subtract: 7/10 - 3/10", answer: "4/10", alternateAnswers: ["2/5"], hint: "Subtract numerators, keep denominator", explanation: "7/10 - 3/10 = 4/10 = 2/5", xp: 12 },
                    { question: "What is 3/6 + 2/6? Simplify if you can.", answer: "5/6", hint: "Add numerators, keep the 6", explanation: "3/6 + 2/6 = 5/6", xp: 12 },
                ],
                exitTicket: [
                    { question: "Add: 2/9 + 5/9", answer: "7/9", hint: "Use what you learned about same denominators", explanation: "2/9 + 5/9 = 7/9", xp: 15 },
                    { question: "Sarah ate 2/8 of a pizza. Tom ate 3/8. How much did they eat together?", answer: "5/8", hint: "Add the two fractions", explanation: "2/8 + 3/8 = 5/8 of the pizza", xp: 20 },
                    { question: "Add: 3/11 + 7/11", answer: "10/11", hint: "Add the numerators, keep the denominator 11", explanation: "3/11 + 7/11 = 10/11", xp: 15 },
                    { question: "Jake ate 3/6 of a pizza and Maria ate 2/6. How much did they eat together?", answer: "5/6", hint: "Add the two fractions with the same denominator", explanation: "3/6 + 2/6 = 5/6 of the pizza", xp: 20 },
                ],
                exitTicketBridge: {
                    concept: 'Fractions in the Real World',
                    explanation: "You'll apply fraction addition to real-life situations. The math is the same ‚Äî just read the situation, identify the fractions, and add them like you practiced.",
                    example: {
                        problem: '"Sara ate 1/6 of a cake and Tom ate 2/6. How much did they eat together?"',
                        steps: ['Identify the fractions: 1/6 and 2/6', 'Same denominator ‚Äî just add numerators: 1 + 2 = 3', 'Answer: 3/6 of the cake'],
                        answer: '3/6',
                    },
                },
            },
            'algebra-lesson-2': {
    title: 'Two-Step Equations',
    topic: 'algebra',
    ruleToDiscover: 'To solve a two-step equation, undo operations in reverse order ‚Äî first undo addition/subtraction, then undo multiplication/division.',
    warmup: [
        { question: 'What is 2x + 3 when x = 4?', answer: '11', hint: 'First substitute x = 4, then follow the order of operations.', explanation: '2 √ó 4 = 8, then 8 + 3 = 11.', xp: 5 },
        { question: 'What is 3x - 5 when x = 6?', answer: '13', hint: 'First multiply 3 by x, then subtract 5.', explanation: '3 √ó 6 = 18, then 18 - 5 = 13.', xp: 5 },
    ],
    discovery: [
        { question: 'x + 5 = 9. What do you do to both sides to get x by itself?', answer: 'subtract 5', hint: 'Think about what operation is being done to x. How do you undo it?', explanation: 'Adding 5 is undone by subtracting 5. x + 5 - 5 = 9 - 5, so x = 4.', xp: 10, alternateAnswers: ['subtract 5 from both sides', '-5', 'take away 5'] },
        { question: '2x = 10. What do you do to both sides to find x?', answer: 'divide by 2', hint: 'x is being multiplied by 2. What is the opposite of multiplying?', explanation: 'Multiplying by 2 is undone by dividing by 2. 2x √∑ 2 = 10 √∑ 2, so x = 5.', xp: 10, alternateAnswers: ['divide both sides by 2', '√∑2', 'divide 2'] },
        { question: '2x + 1 = 7. There are TWO steps. Which do you undo first ‚Äî the +1 or the √ó2?', answer: '+1', hint: 'Undo operations in reverse order. The +1 was done last, so undo it first.', explanation: 'Undo +1 first: 2x = 6. Then undo √ó2: x = 3.', xp: 10, alternateAnswers: ['the addition', 'the plus 1', 'undo the addition first'] },
        { question: 'Finish it: 2x + 1 = 7. After subtracting 1 from both sides you get 2x = 6. What is x?', answer: '3', hint: 'Divide both sides by 2.', explanation: '2x = 6, so x = 6 √∑ 2 = 3. Check: 2(3) + 1 = 7.', xp: 10 },
        { question: 'Solve: 3x - 2 = 10. What is x?', answer: '4', hint: 'Step 1: add 2 to both sides. Step 2: divide both sides by 3.', explanation: '3x = 12, x = 4. Check: 3(4) - 2 = 10.', xp: 10 },
    ],
    application: [
        { question: 'Solve: 4x + 3 = 19. What is x?', answer: '4', hint: 'First subtract 3, then divide by 4.', explanation: '4x = 16, x = 4.', xp: 12 },
        { question: 'Solve: 5x - 7 = 18. What is x?', answer: '5', hint: 'First add 7, then divide by 5.', explanation: '5x = 25, x = 5.', xp: 12 },
        { question: 'Solve: 2x + 9 = 21. What is x?', answer: '6', hint: 'Undo addition first, then multiplication.', explanation: '2x = 12, x = 6.', xp: 12 },
        { question: 'Solve: 6x - 4 = 14. What is x?', answer: '3', hint: 'Add 4 to both sides first.', explanation: '6x = 18, x = 3.', xp: 12 },
        { question: 'Solve: 3x + 7 = 25. What is x?', answer: '6', hint: 'Subtract 7 first, then divide by 3.', explanation: '3x = 18, x = 6.', xp: 12 },
        { question: 'Solve: 10x - 5 = 45. What is x?', answer: '5', hint: 'Add 5 to both sides, then divide by 10.', explanation: '10x = 50, x = 5.', xp: 12 },
    ],
    exitTicket: [
        { question: 'A number is doubled and then increased by 5 to get 17. What is the number?', answer: '6', hint: 'Write the equation: 2x + 5 = 17.', explanation: '2x = 12, x = 6.', xp: 20 },
        { question: 'Maya earns $8 per hour. After buying lunch for $4, she has $28 left. How many hours did she work?', answer: '4', hint: '8x - 4 = 28.', explanation: '8x = 32, x = 4 hours.', xp: 20 },
        { question: 'Three times a number, minus 9, equals 15. What is the number?', answer: '8', hint: '3x - 9 = 15.', explanation: '3x = 24, x = 8.', xp: 20 },
        { question: 'A box of crayons costs $5. Sam also bought a notebook for $3. He spent $23 in total. How many boxes did he buy?', answer: '4', hint: '5x + 3 = 23.', explanation: '5x = 20, x = 4 boxes.', xp: 20 },
    ],
    exitTicketBridge: {
        concept: 'Two-Step Word Problems',
        explanation: 'Word problems often hide a two-step equation. Find the quantity being multiplied or divided, assign it a variable, then write and solve the equation in reverse order.',
        example: {
            problem: '"A number is tripled and then 4 is subtracted to get 11. What is the number?"',
            steps: ['Write the equation: 3x ‚àí 4 = 11', 'Step 1 ‚Äî undo subtraction: add 4 ‚Üí 3x = 15', 'Step 2 ‚Äî undo multiplication: divide by 3 ‚Üí x = 5', 'Check: 3(5) ‚àí 4 = 11. Correct!'],
            answer: '5',
        },
    },
},
'geometry-lesson-2': {
    title: 'Area of Triangles',
    topic: 'geometry',
    ruleToDiscover: 'A triangle is exactly half of a rectangle with the same base and height, so its area = (base √ó height) √∑ 2.',
    warmup: [
        { question: 'What is the area of a rectangle with length 5 and width 4?', answer: '20', hint: 'Area = length √ó width.', explanation: 'Area = 5 √ó 4 = 20 square units.', xp: 5 },
        { question: 'What is the area of a rectangle with base 7 and height 3?', answer: '21', hint: 'Multiply base √ó height.', explanation: 'Area = 7 √ó 3 = 21 square units.', xp: 5 },
    ],
    discovery: [
        { question: 'A rectangle is 4 units wide and 6 units tall. What is its area?', answer: '24', hint: 'Area = base √ó height.', explanation: '4 √ó 6 = 24 square units.', xp: 10 },
        { question: 'Draw a diagonal from corner to corner of that rectangle. What fraction of the rectangle is each triangle created?', answer: '1/2', hint: 'The diagonal splits the rectangle into two equal pieces.', explanation: 'Two equal triangles are created. Each is 1/2 of the rectangle.', xp: 10, alternateAnswers: ['half', 'one half', '0.5'] },
        { question: 'The rectangle was 4 √ó 6 = 24 square units. Each triangle is half. What is the area of one triangle?', answer: '12', hint: 'Half of 24 is...?', explanation: '24 √∑ 2 = 12 square units.', xp: 10 },
        { question: 'Which formula gives the area of a triangle with base b and height h? (A) b √ó h  (B) b √ó h √∑ 2  (C) b + h', answer: 'B', hint: 'The triangle is half the rectangle.', explanation: 'Area = (base √ó height) √∑ 2. Answer B.', xp: 10, alternateAnswers: ['b √ó h √∑ 2', 'base times height divided by 2'] },
    ],
    application: [
        { question: 'Find the area of a triangle with base 6 and height 4.', answer: '12', hint: 'Area = (base √ó height) √∑ 2.', explanation: '(6 √ó 4) √∑ 2 = 12.', xp: 12 },
        { question: 'Find the area of a triangle with base 10 and height 5.', answer: '25', hint: 'Multiply then halve.', explanation: '(10 √ó 5) √∑ 2 = 25.', xp: 12 },
        { question: 'Find the area of a triangle with base 8 and height 9.', answer: '36', hint: 'Area = (b √ó h) √∑ 2.', explanation: '(8 √ó 9) √∑ 2 = 36.', xp: 12 },
        { question: 'Find the area of a triangle with base 3 and height 14.', answer: '21', hint: 'Multiply first, then halve.', explanation: '(3 √ó 14) √∑ 2 = 21.', xp: 12 },
        { question: 'Find the area of a triangle with base 11 and height 6.', answer: '33', hint: 'Area = (base √ó height) √∑ 2.', explanation: '(11 √ó 6) √∑ 2 = 33.', xp: 12 },
        { question: 'A right triangle has legs 7 and 8. What is its area?', answer: '28', hint: 'The two legs are the base and height.', explanation: '(7 √ó 8) √∑ 2 = 28.', xp: 12 },
    ],
    exitTicket: [
        { question: 'A triangular garden has base 12 m and height 5 m. What is its area?', answer: '30', hint: 'Use the triangle area formula.', explanation: '(12 √ó 5) √∑ 2 = 30 sq m.', xp: 20 },
        { question: 'A triangular sail has area 40 sq ft and base 8 ft. What is its height?', answer: '10', hint: 'Rearrange: height = (area √ó 2) √∑ base.', explanation: '(40 √ó 2) √∑ 8 = 10 ft.', xp: 20 },
        { question: 'A triangle has area 27 sq units and height 6. What is its base?', answer: '9', hint: 'base = (area √ó 2) √∑ height.', explanation: '(27 √ó 2) √∑ 6 = 9 units.', xp: 20 },
        { question: 'Two triangles each have base 5 cm and height 8 cm. What is their combined area?', answer: '40', hint: 'Find the area of one, then double it.', explanation: 'One triangle: 20 sq cm. Two: 40 sq cm.', xp: 20 },
    ],
    exitTicketBridge: {
        concept: 'Working Backwards with Area',
        explanation: 'When you know the area and need a missing side, rearrange the formula. Since area = (base √ó height) √∑ 2, you can write: base √ó height = area √ó 2, then divide by the known side.',
        example: {
            problem: '"A triangle has area 18 sq units and base 9. Find the height."',
            steps: ['Write the formula: 18 = (9 √ó height) √∑ 2', 'Multiply both sides by 2: 36 = 9 √ó height', 'Divide by 9: height = 4', 'Check: (9 √ó 4) √∑ 2 = 18. Correct!'],
            answer: '4',
        },
    },
},
'fractions-lesson-2': {
    title: 'Multiplying Fractions',
    topic: 'fractions',
    ruleToDiscover: 'To multiply fractions, multiply the numerators together and the denominators together. No common denominator needed!',
    warmup: [
        { question: 'A pizza is cut into 4 equal slices and you eat 3. What fraction did you eat?', answer: '3/4', hint: 'Part eaten √∑ total slices.', explanation: '3 out of 4 slices = 3/4.', xp: 5 },
        { question: 'A ribbon is cut into 8 equal pieces and you take 5. What fraction do you have?', answer: '5/8', hint: 'Pieces you have √∑ total pieces.', explanation: '5 out of 8 pieces = 5/8.', xp: 5 },
    ],
    discovery: [
        { question: 'Take a square, shade 1/2 of it. Then cut that shaded half in half again. What fraction of the whole square is now shaded?', answer: '1/4', hint: 'The square is now in 4 equal pieces. How many are shaded?', explanation: '1/2 √ó 1/2 = 1/4. Multiply top √ó top, bottom √ó bottom.', xp: 10 },
        { question: 'So what is 1/2 √ó 1/2?', answer: '1/4', hint: 'Use the pattern: multiply numerators, multiply denominators.', explanation: '(1 √ó 1) √∑ (2 √ó 2) = 1/4.', xp: 10 },
        { question: 'What is 2/3 √ó 1/2? (Multiply top √ó top, bottom √ó bottom.)', answer: '2/6', hint: 'Numerator: 2 √ó 1. Denominator: 3 √ó 2.', explanation: '2/6 = 1/3.', xp: 10, alternateAnswers: ['1/3'] },
        { question: 'What is 3/4 √ó 2/5?', answer: '6/20', hint: 'Multiply the two numerators. Multiply the two denominators.', explanation: '(3 √ó 2) √∑ (4 √ó 5) = 6/20 = 3/10.', xp: 10, alternateAnswers: ['3/10'] },
    ],
    application: [
        { question: 'Multiply: 1/3 √ó 1/4', answer: '1/12', hint: '1 √ó 1 = 1. 3 √ó 4 = 12.', explanation: '1/12.', xp: 12 },
        { question: 'Multiply: 2/3 √ó 3/4', answer: '6/12', hint: 'Top √ó top, bottom √ó bottom.', explanation: '6/12 = 1/2.', xp: 12, alternateAnswers: ['1/2'] },
        { question: 'Multiply: 3/5 √ó 2/3', answer: '6/15', hint: 'Multiply across top and bottom.', explanation: '6/15 = 2/5.', xp: 12, alternateAnswers: ['2/5'] },
        { question: 'Multiply: 4/7 √ó 1/2', answer: '4/14', hint: '4 √ó 1 = 4. 7 √ó 2 = 14.', explanation: '4/14 = 2/7.', xp: 12, alternateAnswers: ['2/7'] },
        { question: 'Multiply: 5/6 √ó 3/5', answer: '15/30', hint: 'Top √ó top, bottom √ó bottom, then simplify.', explanation: '15/30 = 1/2.', xp: 12, alternateAnswers: ['1/2'] },
        { question: 'Multiply: 2/9 √ó 3/4', answer: '6/36', hint: 'Multiply numerators and denominators.', explanation: '6/36 = 1/6.', xp: 12, alternateAnswers: ['1/6'] },
    ],
    exitTicket: [
        { question: '1/3 of 18 apples ‚Äî how many apples?', answer: '6', hint: '"Of" means multiply. 1/3 √ó 18 = 18 √∑ 3.', explanation: '18 √∑ 3 = 6 apples.', xp: 20 },
        { question: 'A rope is 20 m long. You use 2/5 of it. How many meters did you use?', answer: '8', hint: '2/5 √ó 20: divide by 5, then multiply by 2.', explanation: '(20 √∑ 5) √ó 2 = 8 m.', xp: 20 },
        { question: 'A class has 24 students. 3/4 of them packed lunch. How many packed lunch?', answer: '18', hint: 'Divide 24 by 4, then multiply by 3.', explanation: '(24 √∑ 4) √ó 3 = 18 students.', xp: 20 },
        { question: 'A bag of flour weighs 5/6 kg. You use 1/2 of the bag. How many kg did you use?', answer: '5/12', hint: '5/6 √ó 1/2: top √ó top, bottom √ó bottom.', explanation: '5/12 kg.', xp: 20 },
    ],
    exitTicketBridge: {
        concept: 'Fractions of a Whole Number',
        explanation: 'When you see "fraction of a number", it always means multiply. To keep numbers manageable, divide by the denominator first, then multiply by the numerator.',
        example: {
            problem: '"Find 3/4 of 12."',
            steps: ['"Of" means √ó: write 3/4 √ó 12', 'Divide by denominator first: 12 √∑ 4 = 3', 'Multiply by numerator: 3 √ó 3 = 9', 'Check: 3/4 √ó 12 = 36/4 = 9. Correct!'],
            answer: '9',
        },
    },
},
'ratios-lesson-1': {
    title: 'Introduction to Ratios',
    topic: 'ratios',
    ruleToDiscover: 'A ratio compares two quantities. Equivalent ratios are formed by multiplying or dividing both parts by the same number ‚Äî just like equivalent fractions.',
    warmup: [
        { question: 'There are 4 apples and 6 oranges in a bowl. How many fruits are there in total?', answer: '10', hint: 'Add apples and oranges.', explanation: '4 + 6 = 10 fruits.', xp: 5 },
        { question: 'In a class there are 3 boys and 5 girls. For every 3 boys, how many girls are there?', answer: '5', hint: 'Read the comparison directly.', explanation: 'For every 3 boys there are 5 girls ‚Äî that is the ratio 3:5.', xp: 5 },
    ],
    discovery: [
        { question: 'There are 4 red tiles and 6 blue tiles. Write the ratio of red to blue.', answer: '4:6', hint: 'Red comes first because the question says "red to blue."', explanation: '4 red to 6 blue = 4:6.', xp: 10 },
        { question: 'The ratio 4:6 can be simplified. Divide both numbers by 2. What is the simplified ratio?', answer: '2:3', hint: '4 √∑ 2 = ?, 6 √∑ 2 = ?', explanation: '4 √∑ 2 = 2, 6 √∑ 2 = 3. Simplified: 2:3.', xp: 10 },
        { question: 'Are 2:3 and 4:6 equivalent? Explain by multiplying 2:3 by 2.', answer: 'yes', hint: 'Multiply both parts of 2:3 by 2.', explanation: '2 √ó 2 = 4, 3 √ó 2 = 6. So 2:3 = 4:6. They are equivalent.', xp: 10, alternateAnswers: ['yes they are', 'they are equivalent', 'yes, equivalent'] },
        { question: 'Starting from 1:4, what ratio do you get if you multiply both parts by 3?', answer: '3:12', hint: '1 √ó 3 = ?, 4 √ó 3 = ?', explanation: '1 √ó 3 = 3, 4 √ó 3 = 12. Equivalent ratio: 3:12.', xp: 10 },
        { question: 'Simplify the ratio 10:15 by dividing both parts by 5.', answer: '2:3', hint: '10 √∑ 5 = ?, 15 √∑ 5 = ?', explanation: '10 √∑ 5 = 2, 15 √∑ 5 = 3. Simplified: 2:3.', xp: 10 },
    ],
    application: [
        { question: 'Write the ratio of cats to dogs if there are 5 cats and 8 dogs.', answer: '5:8', hint: 'Cats first.', explanation: '5 cats to 8 dogs = 5:8.', xp: 12 },
        { question: 'Simplify the ratio 6:9.', answer: '2:3', hint: 'Divide both by 3.', explanation: '6 √∑ 3 = 2, 9 √∑ 3 = 3. Simplified: 2:3.', xp: 12 },
        { question: 'Simplify the ratio 8:12.', answer: '2:3', hint: 'Divide both by 4.', explanation: '8 √∑ 4 = 2, 12 √∑ 4 = 3. Simplified: 2:3.', xp: 12 },
        { question: 'Find an equivalent ratio to 3:5 by multiplying both parts by 4.', answer: '12:20', hint: '3 √ó 4 = ?, 5 √ó 4 = ?', explanation: '12:20.', xp: 12 },
        { question: 'Is 3:4 equivalent to 9:12?', answer: 'yes', hint: 'Try multiplying 3:4 by 3.', explanation: '3 √ó 3 = 9, 4 √ó 3 = 12. Yes, they are equivalent.', xp: 12, alternateAnswers: ['yes they are', 'they are equivalent'] },
        { question: 'The ratio of green to yellow marbles is 2:5. There are 10 yellow marbles. How many green marbles are there?', answer: '4', hint: '5 √ó ? = 10. Apply the same multiplier to green.', explanation: '5 √ó 2 = 10, so 2 √ó 2 = 4 green marbles.', xp: 12 },
    ],
    exitTicket: [
        { question: 'A recipe needs 2 cups of flour for every 3 cups of sugar. How many cups of flour for 9 cups of sugar?', answer: '6', hint: '3 √ó ? = 9. Apply to flour too.', explanation: '3 √ó 3 = 9, so 2 √ó 3 = 6 cups of flour.', xp: 20 },
        { question: 'A car travels 60 miles in 2 hours. At the same speed, how far in 5 hours?', answer: '150', hint: 'Find miles per hour first: 60 √∑ 2. Then multiply by 5.', explanation: '30 mph √ó 5 hours = 150 miles.', xp: 20 },
        { question: 'A team has a wins-to-losses ratio of 3:1. They played 20 games total. How many wins?', answer: '15', hint: '3 + 1 = 4 games per cycle. 20 √∑ 4 = 5 cycles. Wins = 5 √ó 3.', explanation: '5 cycles √ó 3 wins = 15 wins.', xp: 20 },
        { question: 'A juice mix uses 1 part syrup to 4 parts water. You want 15 cups total. How many cups of water?', answer: '12', hint: '1 + 4 = 5 parts. 15 √∑ 5 = 3 cups per part. Water = 4 parts.', explanation: '4 √ó 3 = 12 cups of water.', xp: 20 },
    ],
    exitTicketBridge: {
        concept: 'Scaling with Ratios',
        explanation: 'To find an equivalent ratio, decide what number you need to multiply one part by, then apply that same multiplier to the other part. This is the same idea as scaling up a recipe.',
        example: {
            problem: '"A paint mix uses blue:white = 2:3. How much blue for 12 cups of white?"',
            steps: ['Write the ratio: 2:3', 'White goes from 3 to 12: multiply by 4', 'Apply the same to blue: 2 √ó 4 = 8', 'Check: 8:12 ‚Üí divide by 4 ‚Üí 2:3. Correct!'],
            answer: '8',
        },
    },
},
        };

        const PROBLEMS = {
            algebra: [
                { question: "Solve for x: 2x + 5 = 15", answer: "5", hint: "Subtract 5 from both sides first", explanation: "2x + 5 = 15 ‚Üí 2x = 10 ‚Üí x = 5", xp: 15 },
                { question: "What is x if 3x = 21?", answer: "7", hint: "Divide both sides by 3", explanation: "3x = 21 ‚Üí x = 7", xp: 10 },
                { question: "Solve: 4x - 8 = 12", answer: "5", hint: "Add 8, then divide by 4", explanation: "4x - 8 = 12 ‚Üí 4x = 20 ‚Üí x = 5", xp: 15 },
                { question: "Solve: 5x - 10 = 25", answer: "7", hint: "Add 10 to both sides, then divide by 5", explanation: "5x - 10 = 25 ‚Üí 5x = 35 ‚Üí x = 7", xp: 15 },
                { question: "Solve: 2x + 11 = 27", answer: "8", hint: "Subtract 11 from both sides, then divide by 2", explanation: "2x + 11 = 27 ‚Üí 2x = 16 ‚Üí x = 8", xp: 15 },
                { question: "Solve: 9x - 18 = 45", answer: "7", hint: "Add 18 to both sides, then divide by 9", explanation: "9x - 18 = 45 ‚Üí 9x = 63 ‚Üí x = 7", xp: 20 },
            ],
            geometry: [
                { question: "A square has a side of 6 cm. What is its perimeter?", answer: "24", hint: "Perimeter = 4 * side", explanation: "P = 4 * 6 = 24 cm", xp: 10 },
                { question: "Triangle with angles 60 degrees and 80 degrees. Find the third angle.", answer: "40", hint: "Triangle angles sum to 180 degrees", explanation: "180 - 60 - 80 = 40 degrees", xp: 15 },
                { question: "Rectangle with length 7 m and width 3 m. What is its area?", answer: "21", hint: "Area = length * width", explanation: "A = 7 * 3 = 21 m¬≤", xp: 10 },
                { question: "A rectangle has perimeter 22 cm and width 4 cm. What is its length?", answer: "7", hint: "2(length + width) = 22, so length + width = 11", explanation: "11 - 4 = 7 cm", xp: 15 },
            ],
            fractions: [
                { question: "Add: 1/4 + 1/4", answer: "1/2", alternateAnswers: ["2/4"], hint: "Add numerators, keep denominator", explanation: "1/4 + 1/4 = 2/4 = 1/2", xp: 10 },
                { question: "What is 1/2 of 20?", answer: "10", hint: "Divide 20 by 2", explanation: "1/2 * 20 = 20/2 = 10", xp: 10 },
                { question: "Add: 2/6 + 3/6", answer: "5/6", hint: "Keep the denominator, add numerators", explanation: "2/6 + 3/6 = 5/6", xp: 10 },
                { question: "What is 3/4 - 1/4?", answer: "2/4", alternateAnswers: ["1/2"], hint: "Subtract numerators, keep denominator", explanation: "3/4 - 1/4 = 2/4 = 1/2", xp: 10 },
            ],
        };

        // Question bank: 50 questions per module, 10 per difficulty level (1=easiest, 5=hardest).
        // XP scale: D1‚Üí5, D2‚Üí8, D3‚Üí12, D4‚Üí18, D5‚Üí25
        const QUESTION_BANK = {
            algebra: [
                // --- Difficulty 1: Variable substitution ---
                { difficulty: 1, question: "What is x + 2 when x = 3?", answer: "5", hint: "Replace x with 3, then add", explanation: "3 + 2 = 5", xp: 5 },
                { difficulty: 1, question: "What is x + 5 when x = 4?", answer: "9", hint: "Replace x with 4, then add", explanation: "4 + 5 = 9", xp: 5 },
                { difficulty: 1, question: "If y = 6, what is y - 2?", answer: "4", hint: "Replace y with 6, then subtract", explanation: "6 - 2 = 4", xp: 5 },
                { difficulty: 1, question: "What is 2 √ó x when x = 5?", answer: "10", hint: "Replace x with 5, then multiply by 2", explanation: "2 √ó 5 = 10", xp: 5 },
                { difficulty: 1, question: "If a = 7, what is a + 3?", answer: "10", hint: "Replace a with 7, then add", explanation: "7 + 3 = 10", xp: 5 },
                { difficulty: 1, question: "What is x - 1 when x = 8?", answer: "7", hint: "Replace x with 8, then subtract 1", explanation: "8 - 1 = 7", xp: 5 },
                { difficulty: 1, question: "If b = 4, what is b + 4?", answer: "8", hint: "Replace b with 4, then add 4", explanation: "4 + 4 = 8", xp: 5 },
                { difficulty: 1, question: "What is 3 √ó x when x = 3?", answer: "9", hint: "Replace x with 3, then multiply by 3", explanation: "3 √ó 3 = 9", xp: 5 },
                { difficulty: 1, question: "If m = 9, what is m - 5?", answer: "4", hint: "Replace m with 9, then subtract 5", explanation: "9 - 5 = 4", xp: 5 },
                { difficulty: 1, question: "What is 2 √ó x + 1 when x = 3?", answer: "7", hint: "First replace x with 3, multiply, then add 1", explanation: "2 √ó 3 + 1 = 6 + 1 = 7", xp: 5 },
                // --- Difficulty 2: One-step equations ---
                { difficulty: 2, question: "x + 3 = 8. What is x?", answer: "5", hint: "What number plus 3 equals 8?", explanation: "8 - 3 = 5, so x = 5", xp: 8 },
                { difficulty: 2, question: "x + 6 = 10. What is x?", answer: "4", hint: "Subtract 6 from both sides", explanation: "10 - 6 = 4, so x = 4", xp: 8 },
                { difficulty: 2, question: "x - 2 = 5. What is x?", answer: "7", hint: "Add 2 to both sides", explanation: "5 + 2 = 7, so x = 7", xp: 8 },
                { difficulty: 2, question: "2x = 10. What is x?", answer: "5", hint: "Divide both sides by 2", explanation: "10 √∑ 2 = 5, so x = 5", xp: 8 },
                { difficulty: 2, question: "3x = 18. What is x?", answer: "6", hint: "Divide both sides by 3", explanation: "18 √∑ 3 = 6, so x = 6", xp: 8 },
                { difficulty: 2, question: "x + 7 = 15. What is x?", answer: "8", hint: "Subtract 7 from both sides", explanation: "15 - 7 = 8, so x = 8", xp: 8 },
                { difficulty: 2, question: "4x = 28. What is x?", answer: "7", hint: "Divide both sides by 4", explanation: "28 √∑ 4 = 7, so x = 7", xp: 8 },
                { difficulty: 2, question: "x / 3 = 5. What is x?", answer: "15", hint: "Multiply both sides by 3", explanation: "5 √ó 3 = 15, so x = 15", xp: 8 },
                { difficulty: 2, question: "x - 8 = 6. What is x?", answer: "14", hint: "Add 8 to both sides", explanation: "6 + 8 = 14, so x = 14", xp: 8 },
                { difficulty: 2, question: "5x = 40. What is x?", answer: "8", hint: "Divide both sides by 5", explanation: "40 √∑ 5 = 8, so x = 8", xp: 8 },
                // --- Difficulty 3: Two-step equations ---
                { difficulty: 3, question: "2x + 3 = 11. What is x?", answer: "4", hint: "First subtract 3 from both sides, then divide by 2", explanation: "2x = 8, x = 4", xp: 12 },
                { difficulty: 3, question: "3x - 4 = 11. What is x?", answer: "5", hint: "First add 4 to both sides, then divide by 3", explanation: "3x = 15, x = 5", xp: 12 },
                { difficulty: 3, question: "2x + 5 = 17. What is x?", answer: "6", hint: "Subtract 5 from both sides, then divide by 2", explanation: "2x = 12, x = 6", xp: 12 },
                { difficulty: 3, question: "4x - 5 = 19. What is x?", answer: "6", hint: "Add 5 to both sides, then divide by 4", explanation: "4x = 24, x = 6", xp: 12 },
                { difficulty: 3, question: "5x + 2 = 22. What is x?", answer: "4", hint: "Subtract 2 from both sides, then divide by 5", explanation: "5x = 20, x = 4", xp: 12 },
                { difficulty: 3, question: "2x - 3 = 11. What is x?", answer: "7", hint: "Add 3 to both sides, then divide by 2", explanation: "2x = 14, x = 7", xp: 12 },
                { difficulty: 3, question: "6x + 1 = 25. What is x?", answer: "4", hint: "Subtract 1 from both sides, then divide by 6", explanation: "6x = 24, x = 4", xp: 12 },
                { difficulty: 3, question: "4x + 3 = 19. What is x?", answer: "4", hint: "Subtract 3 from both sides, then divide by 4", explanation: "4x = 16, x = 4", xp: 12 },
                { difficulty: 3, question: "2x + 4 = 20. What is x?", answer: "8", hint: "Subtract 4 from both sides, then divide by 2", explanation: "2x = 16, x = 8", xp: 12 },
                { difficulty: 3, question: "3x - 6 = 15. What is x?", answer: "7", hint: "Add 6 to both sides, then divide by 3", explanation: "3x = 21, x = 7", xp: 12 },
                // --- Difficulty 4: Multi-step / word problems ---
                { difficulty: 4, question: "Three times a number plus 4 equals 19. What is the number?", answer: "5", hint: "Write it as 3n + 4 = 19, then solve", explanation: "3n = 15, n = 5", xp: 18 },
                { difficulty: 4, question: "Twice a number minus 8 equals 12. What is the number?", answer: "10", hint: "Write it as 2n - 8 = 12, then solve", explanation: "2n = 20, n = 10", xp: 18 },
                { difficulty: 4, question: "2(x + 3) = 14. What is x?", answer: "4", hint: "Distribute the 2, then solve the two-step equation", explanation: "2x + 6 = 14, 2x = 8, x = 4", xp: 18 },
                { difficulty: 4, question: "3(x - 1) = 12. What is x?", answer: "5", hint: "Distribute the 3, then solve", explanation: "3x - 3 = 12, 3x = 15, x = 5", xp: 18 },
                { difficulty: 4, question: "2x + 3x = 25. What is x?", answer: "5", hint: "Combine the like terms on the left side first", explanation: "5x = 25, x = 5", xp: 18 },
                { difficulty: 4, question: "5x + 2 = 3x + 12. What is x?", answer: "5", hint: "Move all x terms to one side and numbers to the other", explanation: "2x = 10, x = 5", xp: 18 },
                { difficulty: 4, question: "6x - 4 = 2x + 16. What is x?", answer: "5", hint: "Subtract 2x from both sides, then add 4 to both sides", explanation: "4x = 20, x = 5", xp: 18 },
                { difficulty: 4, question: "4(x - 3) = 16. What is x?", answer: "7", hint: "Distribute 4 first: 4x - 12 = 16", explanation: "4x = 28, x = 7", xp: 18 },
                { difficulty: 4, question: "2(3x + 1) = 20. What is x?", answer: "3", hint: "Distribute the 2 first: 6x + 2 = 20", explanation: "6x = 18, x = 3", xp: 18 },
                { difficulty: 4, question: "Three consecutive integers sum to 27. What is the middle one?", answer: "9", hint: "Call them n-1, n, n+1. Their sum is 3n.", explanation: "3n = 27, n = 9", xp: 18 },
                // --- Difficulty 5: Complex, variables on both sides ---
                { difficulty: 5, question: "4x + 3 = 2x + 15. What is x?", answer: "6", hint: "Move x terms to one side: 4x - 2x = 15 - 3", explanation: "2x = 12, x = 6", xp: 25 },
                { difficulty: 5, question: "5x - 7 = 3x + 11. What is x?", answer: "9", hint: "Move x terms to one side: 5x - 3x = 11 + 7", explanation: "2x = 18, x = 9", xp: 25 },
                { difficulty: 5, question: "3(x + 4) = 2(x + 9). What is x?", answer: "6", hint: "Distribute both sides first, then collect x terms", explanation: "3x + 12 = 2x + 18, x = 6", xp: 25 },
                { difficulty: 5, question: "2(x + 3) = 3(x - 1). What is x?", answer: "9", hint: "Distribute both sides: 2x + 6 = 3x - 3", explanation: "9 = x", xp: 25 },
                { difficulty: 5, question: "5(x - 2) = 3(x + 2). What is x?", answer: "8", hint: "Distribute: 5x - 10 = 3x + 6", explanation: "2x = 16, x = 8", xp: 25 },
                { difficulty: 5, question: "2(3x - 4) = 4(x + 1). What is x?", answer: "6", hint: "Distribute: 6x - 8 = 4x + 4", explanation: "2x = 12, x = 6", xp: 25 },
                { difficulty: 5, question: "(x + 5) / 3 = 4. What is x?", answer: "7", hint: "Multiply both sides by 3 first", explanation: "x + 5 = 12, x = 7", xp: 25 },
                { difficulty: 5, question: "4(2x - 3) = 2(3x + 1). What is x?", answer: "7", hint: "Distribute both sides: 8x - 12 = 6x + 2", explanation: "2x = 14, x = 7", xp: 25 },
                { difficulty: 5, question: "5(x + 1) - 3(x - 1) = 18. What is x?", answer: "5", hint: "Distribute both brackets, then simplify", explanation: "5x + 5 - 3x + 3 = 18, 2x + 8 = 18, x = 5", xp: 25 },
                { difficulty: 5, question: "4(x + 3) - 2(x - 1) = 20. What is x?", answer: "3", hint: "Distribute both brackets: 4x + 12 - 2x + 2 = 20", explanation: "2x + 14 = 20, 2x = 6, x = 3", xp: 25 },
            ],
            geometry: [
                // --- Difficulty 1: Basic shape properties, simple calculations ---
                { difficulty: 1, question: "How many sides does a rectangle have?", answer: "4", hint: "Count them: top, bottom, left, right", explanation: "A rectangle has 4 sides", xp: 5 },
                { difficulty: 1, question: "How many sides does a triangle have?", answer: "3", hint: "Think of the three corners", explanation: "A triangle has 3 sides", xp: 5 },
                { difficulty: 1, question: "A square has side 3 cm. What is its perimeter?", answer: "12", hint: "Add all 4 equal sides together", explanation: "4 √ó 3 = 12 cm", xp: 5 },
                { difficulty: 1, question: "A square has side 2 cm. What is its area?", answer: "4", hint: "Area = side √ó side", explanation: "2 √ó 2 = 4 cm¬≤", xp: 5 },
                { difficulty: 1, question: "A rectangle has length 4 and width 2. What is its area?", answer: "8", hint: "Area = length √ó width", explanation: "4 √ó 2 = 8", xp: 5 },
                { difficulty: 1, question: "What shape has 4 equal sides and 4 right angles?", answer: "square", hint: "It's a special rectangle where all sides match", explanation: "A square has 4 equal sides and 4 right angles", xp: 5 },
                { difficulty: 1, question: "A square has side 4 cm. What is its perimeter?", answer: "16", hint: "Add all 4 equal sides", explanation: "4 √ó 4 = 16 cm", xp: 5 },
                { difficulty: 1, question: "A rectangle has length 5 and width 1. What is its area?", answer: "5", hint: "Area = length √ó width", explanation: "5 √ó 1 = 5", xp: 5 },
                { difficulty: 1, question: "A square has side 3 cm. What is its area?", answer: "9", hint: "Area = side √ó side", explanation: "3 √ó 3 = 9 cm¬≤", xp: 5 },
                { difficulty: 1, question: "A rectangle has length 4 and width 2. What is its perimeter?", answer: "12", hint: "Add all four sides: 4 + 2 + 4 + 2", explanation: "4 + 2 + 4 + 2 = 12", xp: 5 },
                // --- Difficulty 2: Larger numbers, perimeter and area ---
                { difficulty: 2, question: "A rectangle has length 8 and width 5. What is its area?", answer: "40", hint: "Area = length √ó width", explanation: "8 √ó 5 = 40", xp: 8 },
                { difficulty: 2, question: "A rectangle has length 10 and width 4. What is its perimeter?", answer: "28", hint: "Use 2(length + width)", explanation: "2(10 + 4) = 2(14) = 28", xp: 8 },
                { difficulty: 2, question: "A square has side 7 cm. What is its perimeter?", answer: "28", hint: "Perimeter = 4 √ó side", explanation: "4 √ó 7 = 28 cm", xp: 8 },
                { difficulty: 2, question: "A square has side 8 cm. What is its area?", answer: "64", hint: "Area = side √ó side", explanation: "8 √ó 8 = 64 cm¬≤", xp: 8 },
                { difficulty: 2, question: "A rectangle has length 12 and width 6. What is its area?", answer: "72", hint: "Area = length √ó width", explanation: "12 √ó 6 = 72", xp: 8 },
                { difficulty: 2, question: "A rectangle has length 9 and width 3. What is its perimeter?", answer: "24", hint: "Use 2(length + width)", explanation: "2(9 + 3) = 2(12) = 24", xp: 8 },
                { difficulty: 2, question: "A square has side 9 cm. What is its perimeter?", answer: "36", hint: "Perimeter = 4 √ó side", explanation: "4 √ó 9 = 36 cm", xp: 8 },
                { difficulty: 2, question: "A square has side 11 cm. What is its area?", answer: "121", hint: "Area = side √ó side", explanation: "11 √ó 11 = 121 cm¬≤", xp: 8 },
                { difficulty: 2, question: "A rectangle has length 7 and width 4. What is its area?", answer: "28", hint: "Area = length √ó width", explanation: "7 √ó 4 = 28", xp: 8 },
                { difficulty: 2, question: "A rectangle has length 6 and width 5. What is its perimeter?", answer: "22", hint: "Use 2(length + width)", explanation: "2(6 + 5) = 2(11) = 22", xp: 8 },
                // --- Difficulty 3: Missing dimensions, triangle angles ---
                { difficulty: 3, question: "A rectangle has perimeter 24 cm and length 8 cm. What is its width?", answer: "4", hint: "2(8 + w) = 24, so 8 + w = 12", explanation: "12 - 8 = 4 cm", xp: 12 },
                { difficulty: 3, question: "A rectangle has area 36 m¬≤ and length 9 m. What is its width?", answer: "4", hint: "Area = length √ó width, so width = area √∑ length", explanation: "36 √∑ 9 = 4 m", xp: 12 },
                { difficulty: 3, question: "A triangle has angles 40¬∞ and 70¬∞. What is the third angle?", answer: "70", hint: "Angles in a triangle always add up to 180¬∞", explanation: "180 - 40 - 70 = 70¬∞", xp: 12 },
                { difficulty: 3, question: "A triangle has angles 90¬∞ and 45¬∞. What is the third angle?", answer: "45", hint: "Angles in a triangle always add up to 180¬∞", explanation: "180 - 90 - 45 = 45¬∞", xp: 12 },
                { difficulty: 3, question: "A rectangle has perimeter 30 cm and width 7 cm. What is its length?", answer: "8", hint: "2(l + 7) = 30, so l + 7 = 15", explanation: "15 - 7 = 8 cm", xp: 12 },
                { difficulty: 3, question: "A square has area 49 m¬≤. What is the length of one side?", answer: "7", hint: "What number times itself equals 49?", explanation: "7 √ó 7 = 49, so side = 7 m", xp: 12 },
                { difficulty: 3, question: "A square has area 64 cm¬≤. What is the length of one side?", answer: "8", hint: "What number times itself equals 64?", explanation: "8 √ó 8 = 64, so side = 8 cm", xp: 12 },
                { difficulty: 3, question: "A rectangle has area 60 cm¬≤ and length 12 cm. What is its width?", answer: "5", hint: "Width = area √∑ length", explanation: "60 √∑ 12 = 5 cm", xp: 12 },
                { difficulty: 3, question: "A triangle has angles 30¬∞ and 80¬∞. What is the third angle?", answer: "70", hint: "Angles in a triangle always add up to 180¬∞", explanation: "180 - 30 - 80 = 70¬∞", xp: 12 },
                { difficulty: 3, question: "A square has perimeter 44 cm. What is the length of one side?", answer: "11", hint: "Perimeter = 4 √ó side, so side = perimeter √∑ 4", explanation: "44 √∑ 4 = 11 cm", xp: 12 },
                // --- Difficulty 4: Multi-step word problems ---
                { difficulty: 4, question: "A rectangular garden's length is 3 m more than its width. Its perimeter is 22 m. What is its width?", answer: "4", hint: "Call width w. Then 2(w + w + 3) = 22", explanation: "4w + 6 = 22, 4w = 16, w = 4 m", xp: 18 },
                { difficulty: 4, question: "A rectangle has area 100 m¬≤ and width 5 m. What is its perimeter?", answer: "50", hint: "First find the length, then calculate perimeter", explanation: "length = 100 √∑ 5 = 20, P = 2(20 + 5) = 50 m", xp: 18 },
                { difficulty: 4, question: "A square's perimeter equals a rectangle's perimeter. The rectangle is 10 by 6. What is the square's side?", answer: "8", hint: "Find the rectangle's perimeter first, then divide by 4", explanation: "P = 2(10+6) = 32, square side = 32 √∑ 4 = 8", xp: 18 },
                { difficulty: 4, question: "A rectangle has perimeter 36 cm and width 6 cm. What is its area?", answer: "72", hint: "First find the length from the perimeter formula", explanation: "2(l + 6) = 36, l = 12, area = 12 √ó 6 = 72 cm¬≤", xp: 18 },
                { difficulty: 4, question: "A square garden has area 225 m¬≤. What is its perimeter?", answer: "60", hint: "First find the side length (what times itself equals 225?), then multiply by 4", explanation: "side = 15, P = 4 √ó 15 = 60 m", xp: 18 },
                { difficulty: 4, question: "Two squares have sides 3 cm and 4 cm. What is their combined area?", answer: "25", hint: "Find each area separately, then add", explanation: "3¬≤ + 4¬≤ = 9 + 16 = 25 cm¬≤", xp: 18 },
                { difficulty: 4, question: "A triangle's angles are in ratio 1:2:3. What is the largest angle in degrees?", answer: "90", hint: "The angles add to 180¬∞. If they are x, 2x, 3x then 6x = 180", explanation: "x = 30, largest angle = 3 √ó 30 = 90¬∞", xp: 18 },
                { difficulty: 4, question: "A room 8 m by 5 m needs square carpet tiles, each 1 m¬≤. How many tiles are needed?", answer: "40", hint: "Find the area of the room", explanation: "Area = 8 √ó 5 = 40 tiles", xp: 18 },
                { difficulty: 4, question: "A rectangle's length is 3 times its width. Its perimeter is 48 cm. What is its length?", answer: "18", hint: "Call width w, length 3w. Then 2(3w + w) = 48", explanation: "8w = 48, w = 6, length = 3 √ó 6 = 18 cm", xp: 18 },
                { difficulty: 4, question: "Square tiles measure 2 m √ó 2 m. A floor measures 10 m √ó 8 m. How many tiles are needed?", answer: "20", hint: "Divide the floor area by the tile area", explanation: "floor area = 80, tile area = 4, tiles = 80 √∑ 4 = 20", xp: 18 },
                // --- Difficulty 5: Complex, compound shapes, Pythagorean theorem ---
                { difficulty: 5, question: "A right triangle has legs 3 and 4. What is the length of the hypotenuse?", answer: "5", hint: "Use the Pythagorean theorem: a¬≤ + b¬≤ = c¬≤", explanation: "3¬≤ + 4¬≤ = 9 + 16 = 25, ‚àö25 = 5", xp: 25 },
                { difficulty: 5, question: "A triangle has angles (2x)¬∞, (3x)¬∞, and (x)¬∞. What is x?", answer: "30", hint: "All angles in a triangle sum to 180¬∞", explanation: "2x + 3x + x = 180, 6x = 180, x = 30", xp: 25 },
                { difficulty: 5, question: "A rectangle has perimeter 60 cm and length twice its width. What is its area?", answer: "200", hint: "Call width w, length 2w. Use the perimeter formula.", explanation: "2(2w + w) = 60, w = 10, area = 20 √ó 10 = 200 cm¬≤", xp: 25 },
                { difficulty: 5, question: "A composite shape is a 12√ó5 rectangle with a 4√ó4 square removed from one corner. What is the remaining area?", answer: "44", hint: "Find the rectangle's area, then subtract the square's area", explanation: "12 √ó 5 ‚àí 4 √ó 4 = 60 ‚àí 16 = 44", xp: 25 },
                { difficulty: 5, question: "A triangle has base 12 cm and height 8 cm. What is its area?", answer: "48", hint: "Area of a triangle = ¬Ω √ó base √ó height", explanation: "¬Ω √ó 12 √ó 8 = 48 cm¬≤", xp: 25 },
                { difficulty: 5, question: "A right triangle has one leg 5 cm and hypotenuse 13 cm. What is the other leg?", answer: "12", hint: "Use a¬≤ + b¬≤ = c¬≤: 5¬≤ + b¬≤ = 13¬≤", explanation: "25 + b¬≤ = 169, b¬≤ = 144, b = 12 cm", xp: 25 },
                { difficulty: 5, question: "A rectangle's length is 5 more than twice its width. Its perimeter is 46 cm. What is its width?", answer: "6", hint: "Call width w, length 2w+5. Use 2(l+w) = 46.", explanation: "2(3w+5) = 46, 6w = 36, w = 6 cm", xp: 25 },
                { difficulty: 5, question: "What is the sum of the interior angles of a pentagon in degrees?", answer: "540", hint: "A polygon with n sides has interior angles summing to (n‚àí2)√ó180¬∞", explanation: "(5‚àí2) √ó 180 = 3 √ó 180 = 540¬∞", xp: 25 },
                { difficulty: 5, question: "A rectangle is 3 times as long as it is wide. If the area is 108 cm¬≤, what is its width?", answer: "6", hint: "Call width w, length 3w. Area = w √ó 3w = 3w¬≤", explanation: "3w¬≤ = 108, w¬≤ = 36, w = 6 cm", xp: 25 },
                { difficulty: 5, question: "An L-shape is formed by two rectangles: one 8√ó4 and one 4√ó3. What is the total area?", answer: "44", hint: "Find each rectangle's area and add them", explanation: "8 √ó 4 + 4 √ó 3 = 32 + 12 = 44", xp: 25 },
            ],
            fractions: [
                // --- Difficulty 1: Basic fraction concepts ---
                { difficulty: 1, question: "How many halves make a whole?", answer: "2", hint: "2/2 = 1 whole", explanation: "Two halves make one whole", xp: 5 },
                { difficulty: 1, question: "How many quarters make a whole?", answer: "4", hint: "4/4 = 1 whole", explanation: "Four quarters make one whole", xp: 5 },
                { difficulty: 1, question: "How many thirds make a whole?", answer: "3", hint: "3/3 = 1 whole", explanation: "Three thirds make one whole", xp: 5 },
                { difficulty: 1, question: "What fraction represents 1 out of 4 equal parts?", answer: "1/4", hint: "The shaded part goes on top, the total parts on the bottom", explanation: "1 part out of 4 total = 1/4", xp: 5 },
                { difficulty: 1, question: "What fraction represents 2 out of 5 equal parts?", answer: "2/5", hint: "Shaded parts on top, total parts on the bottom", explanation: "2 parts out of 5 total = 2/5", xp: 5 },
                { difficulty: 1, question: "What is 1/2 of 10?", answer: "5", hint: "Divide 10 by 2", explanation: "10 √∑ 2 = 5", xp: 5 },
                { difficulty: 1, question: "What is 1/4 of 8?", answer: "2", hint: "Divide 8 by 4", explanation: "8 √∑ 4 = 2", xp: 5 },
                { difficulty: 1, question: "What is 1/3 of 9?", answer: "3", hint: "Divide 9 by 3", explanation: "9 √∑ 3 = 3", xp: 5 },
                { difficulty: 1, question: "Which fraction is larger: 3/4 or 1/4?", answer: "3/4", hint: "Same denominator ‚Äî compare the numerators", explanation: "3 > 1, so 3/4 is larger", xp: 5 },
                { difficulty: 1, question: "What fraction of a day is 12 hours?", answer: "1/2", hint: "A day has 24 hours. What fraction is 12 out of 24?", explanation: "12/24 = 1/2", xp: 5 },
                // --- Difficulty 2: Add/subtract same-denominator fractions ---
                { difficulty: 2, question: "1/5 + 2/5 = ?", answer: "3/5", hint: "Add the numerators; keep the denominator the same", explanation: "1/5 + 2/5 = 3/5", xp: 8 },
                { difficulty: 2, question: "2/7 + 3/7 = ?", answer: "5/7", hint: "Add the numerators; keep the denominator the same", explanation: "2/7 + 3/7 = 5/7", xp: 8 },
                { difficulty: 2, question: "1/4 + 2/4 = ?", answer: "3/4", hint: "Add the numerators; keep the denominator the same", explanation: "1/4 + 2/4 = 3/4", xp: 8 },
                { difficulty: 2, question: "3/8 + 2/8 = ?", answer: "5/8", hint: "Add the numerators; keep the denominator the same", explanation: "3/8 + 2/8 = 5/8", xp: 8 },
                { difficulty: 2, question: "4/6 + 1/6 = ?", answer: "5/6", hint: "Add the numerators; keep the denominator the same", explanation: "4/6 + 1/6 = 5/6", xp: 8 },
                { difficulty: 2, question: "5/8 - 2/8 = ?", answer: "3/8", hint: "Subtract the numerators; keep the denominator the same", explanation: "5/8 - 2/8 = 3/8", xp: 8 },
                { difficulty: 2, question: "4/5 - 1/5 = ?", answer: "3/5", hint: "Subtract the numerators; keep the denominator the same", explanation: "4/5 - 1/5 = 3/5", xp: 8 },
                { difficulty: 2, question: "6/7 - 2/7 = ?", answer: "4/7", hint: "Subtract the numerators; keep the denominator the same", explanation: "6/7 - 2/7 = 4/7", xp: 8 },
                { difficulty: 2, question: "1/3 + 1/3 = ?", answer: "2/3", hint: "Add the numerators; keep the denominator the same", explanation: "1/3 + 1/3 = 2/3", xp: 8 },
                { difficulty: 2, question: "4/9 + 4/9 = ?", answer: "8/9", hint: "Add the numerators; keep the denominator the same", explanation: "4/9 + 4/9 = 8/9", xp: 8 },
                // --- Difficulty 3: Simplify fractions ---
                { difficulty: 3, question: "Simplify 2/4.", answer: "1/2", hint: "Divide both top and bottom by 2", explanation: "2√∑2 / 4√∑2 = 1/2", xp: 12 },
                { difficulty: 3, question: "Simplify 4/8.", answer: "1/2", hint: "What number divides evenly into both 4 and 8?", explanation: "4√∑4 / 8√∑4 = 1/2", xp: 12 },
                { difficulty: 3, question: "Simplify 6/9.", answer: "2/3", hint: "What number divides evenly into both 6 and 9?", explanation: "6√∑3 / 9√∑3 = 2/3", xp: 12 },
                { difficulty: 3, question: "Simplify 4/6.", answer: "2/3", hint: "What number divides evenly into both 4 and 6?", explanation: "4√∑2 / 6√∑2 = 2/3", xp: 12 },
                { difficulty: 3, question: "Simplify 6/8.", answer: "3/4", hint: "What number divides evenly into both 6 and 8?", explanation: "6√∑2 / 8√∑2 = 3/4", xp: 12 },
                { difficulty: 3, question: "Simplify 6/10.", answer: "3/5", hint: "What number divides evenly into both 6 and 10?", explanation: "6√∑2 / 10√∑2 = 3/5", xp: 12 },
                { difficulty: 3, question: "Simplify 4/12.", answer: "1/3", hint: "What number divides evenly into both 4 and 12?", explanation: "4√∑4 / 12√∑4 = 1/3", xp: 12 },
                { difficulty: 3, question: "Simplify 9/12.", answer: "3/4", hint: "What number divides evenly into both 9 and 12?", explanation: "9√∑3 / 12√∑3 = 3/4", xp: 12 },
                { difficulty: 3, question: "Simplify 5/10.", answer: "1/2", hint: "What number divides evenly into both 5 and 10?", explanation: "5√∑5 / 10√∑5 = 1/2", xp: 12 },
                { difficulty: 3, question: "Simplify 8/12.", answer: "2/3", hint: "What number divides evenly into both 8 and 12?", explanation: "8√∑4 / 12√∑4 = 2/3", xp: 12 },
                // --- Difficulty 4: Unlike denominators (easy LCM), word problems ---
                { difficulty: 4, question: "1/2 + 1/4 = ?", answer: "3/4", hint: "Convert 1/2 to quarters: 1/2 = 2/4", explanation: "2/4 + 1/4 = 3/4", xp: 18 },
                { difficulty: 4, question: "1/2 + 1/6 = ?", answer: "2/3", alternateAnswers: ["4/6"], hint: "Convert to sixths: 1/2 = 3/6", explanation: "3/6 + 1/6 = 4/6 = 2/3", xp: 18 },
                { difficulty: 4, question: "1/3 + 1/6 = ?", answer: "1/2", alternateAnswers: ["3/6"], hint: "Convert to sixths: 1/3 = 2/6", explanation: "2/6 + 1/6 = 3/6 = 1/2", xp: 18 },
                { difficulty: 4, question: "3/4 - 1/2 = ?", answer: "1/4", hint: "Convert 1/2 to quarters: 1/2 = 2/4", explanation: "3/4 - 2/4 = 1/4", xp: 18 },
                { difficulty: 4, question: "1/2 + 1/3 = ?", answer: "5/6", hint: "Find a common denominator: both go into 6", explanation: "3/6 + 2/6 = 5/6", xp: 18 },
                { difficulty: 4, question: "3/8 + 1/4 = ?", answer: "5/8", hint: "Convert 1/4 to eighths: 1/4 = 2/8", explanation: "3/8 + 2/8 = 5/8", xp: 18 },
                { difficulty: 4, question: "5/8 - 1/4 = ?", answer: "3/8", hint: "Convert 1/4 to eighths: 1/4 = 2/8", explanation: "5/8 - 2/8 = 3/8", xp: 18 },
                { difficulty: 4, question: "2/3 + 1/9 = ?", answer: "7/9", hint: "Convert 2/3 to ninths: 2/3 = 6/9", explanation: "6/9 + 1/9 = 7/9", xp: 18 },
                { difficulty: 4, question: "Sara ate 1/3 of a cake and Tom ate 1/6. How much of the cake did they eat together?", answer: "1/2", alternateAnswers: ["3/6"], hint: "Add the fractions: find a common denominator first", explanation: "2/6 + 1/6 = 3/6 = 1/2", xp: 18 },
                { difficulty: 4, question: "A rope is 3/4 m long. You cut off 1/2 m. How much rope is left?", answer: "1/4", hint: "Subtract: convert 1/2 to quarters first", explanation: "3/4 - 2/4 = 1/4 m", xp: 18 },
                // --- Difficulty 5: Multiply/divide fractions, complex word problems ---
                { difficulty: 5, question: "1/2 √ó 3/4 = ?", answer: "3/8", hint: "Multiply numerators together, then multiply denominators", explanation: "1√ó3 / 2√ó4 = 3/8", xp: 25 },
                { difficulty: 5, question: "2/3 √ó 3/4 = ?", answer: "1/2", alternateAnswers: ["6/12"], hint: "Multiply numerators and denominators, then simplify", explanation: "2√ó3 / 3√ó4 = 6/12 = 1/2", xp: 25 },
                { difficulty: 5, question: "1/3 √ó 2/5 = ?", answer: "2/15", hint: "Multiply numerators together, then multiply denominators", explanation: "1√ó2 / 3√ó5 = 2/15", xp: 25 },
                { difficulty: 5, question: "What is 3/4 of 20?", answer: "15", hint: "Multiply: 3/4 √ó 20 = (3 √ó 20) √∑ 4", explanation: "60 √∑ 4 = 15", xp: 25 },
                { difficulty: 5, question: "What is 2/5 of 25?", answer: "10", hint: "Multiply: 2/5 √ó 25 = (2 √ó 25) √∑ 5", explanation: "50 √∑ 5 = 10", xp: 25 },
                { difficulty: 5, question: "1/2 √∑ 2 = ?", answer: "1/4", hint: "Dividing by 2 is the same as multiplying by 1/2", explanation: "1/2 √ó 1/2 = 1/4", xp: 25 },
                { difficulty: 5, question: "2/3 √∑ 4 = ?", answer: "1/6", hint: "Dividing by 4 is the same as multiplying by 1/4", explanation: "2/3 √ó 1/4 = 2/12 = 1/6", xp: 25 },
                { difficulty: 5, question: "1/2 + 1/3 + 1/6 = ?", answer: "1", hint: "Convert everything to sixths: 3/6 + 2/6 + 1/6", explanation: "3/6 + 2/6 + 1/6 = 6/6 = 1", xp: 25 },
                { difficulty: 5, question: "3/4 + 1/6 = ?", answer: "11/12", hint: "Find the common denominator: both go into 12", explanation: "9/12 + 2/12 = 11/12", xp: 25 },
                { difficulty: 5, question: "What fraction of 12 is 9?", answer: "3/4", hint: "Write it as 9/12 and simplify", explanation: "9/12 = 3/4", xp: 25 },
            ],
            ratios: [
                // --- Difficulty 1: Reading and writing ratios (17 questions) ---
                { difficulty: 1, question: "There are 3 red balls and 2 blue balls. What is the ratio of red to blue?", answer: "3:2", hint: "Red comes first. Write red:blue.", explanation: "3 red to 2 blue = 3:2", xp: 5 },
                { difficulty: 1, question: "A bag has 5 apples and 4 oranges. Write the ratio of apples to oranges.", answer: "5:4", hint: "Apples first, then oranges.", explanation: "5 apples to 4 oranges = 5:4", xp: 5 },
                { difficulty: 1, question: "Write the ratio of 7 to 3.", answer: "7:3", hint: "Write them in the order given.", explanation: "7 to 3 is written as 7:3", xp: 5 },
                { difficulty: 1, question: "In a class there are 12 boys and 15 girls. What is the ratio of boys to girls?", answer: "12:15", hint: "Boys first, girls second.", explanation: "12 boys to 15 girls = 12:15", xp: 5 },
                { difficulty: 1, question: "A recipe uses 2 cups of oats and 1 cup of sugar. What is the ratio of oats to sugar?", answer: "2:1", hint: "Oats are mentioned first.", explanation: "2 cups oats : 1 cup sugar = 2:1", xp: 5 },
                { difficulty: 1, question: "A pet store has 6 dogs and 9 cats. What is the ratio of dogs to cats?", answer: "6:9", hint: "Dogs come first in the question.", explanation: "6 dogs to 9 cats = 6:9", xp: 5 },
                { difficulty: 1, question: "Write the ratio of 1 to 4.", answer: "1:4", hint: "First number to second number.", explanation: "1 to 4 is written as 1:4", xp: 5 },
                { difficulty: 1, question: "A parking lot has 8 trucks and 20 cars. What is the ratio of trucks to cars?", answer: "8:20", hint: "Trucks come first.", explanation: "8 trucks to 20 cars = 8:20", xp: 5 },
                { difficulty: 1, question: "A jar holds 4 green marbles and 3 yellow marbles. What is the ratio of yellow to green?", answer: "3:4", hint: "Yellow is asked first this time.", explanation: "3 yellow to 4 green = 3:4", xp: 5 },
                { difficulty: 1, question: "There are 10 students and 2 teachers in a room. What is the ratio of students to teachers?", answer: "10:2", hint: "Students are mentioned first in the question.", explanation: "10 students to 2 teachers = 10:2", xp: 5 },
                { difficulty: 1, question: "A garden has 5 rose bushes and 7 daisy plants. What is the ratio of daisies to roses?", answer: "7:5", hint: "Daisies are asked first.", explanation: "7 daisies to 5 roses = 7:5", xp: 5 },
                { difficulty: 1, question: "Write the ratio of 9 to 4.", answer: "9:4", hint: "Write them in order: first to second.", explanation: "9 to 4 is written as 9:4", xp: 5 },
                { difficulty: 1, question: "A smoothie uses 3 bananas and 2 cups of strawberries. What is the ratio of bananas to strawberries?", answer: "3:2", hint: "Bananas come first.", explanation: "3 bananas to 2 cups strawberries = 3:2", xp: 5 },
                { difficulty: 1, question: "A team scored 5 goals and allowed 1 goal. What is the ratio of goals scored to goals allowed?", answer: "5:1", hint: "Scored first, allowed second.", explanation: "5 scored to 1 allowed = 5:1", xp: 5 },
                { difficulty: 1, question: "A bookshelf has 14 fiction books and 6 non-fiction books. What is the ratio of fiction to non-fiction?", answer: "14:6", hint: "Fiction is mentioned first.", explanation: "14 fiction to 6 non-fiction = 14:6", xp: 5 },
                { difficulty: 1, question: "Write the ratio of 11 to 5.", answer: "11:5", hint: "First number to second number.", explanation: "11 to 5 is written as 11:5", xp: 5 },
                { difficulty: 1, question: "A class voted on a field trip: 18 said yes and 7 said no. What is the ratio of yes to no?", answer: "18:7", hint: "Yes votes come first in the question.", explanation: "18 yes to 7 no = 18:7", xp: 5 },
                // --- Difficulty 2: Equivalent ratios and simplifying (17 questions) ---
                { difficulty: 2, question: "Simplify the ratio 4:6.", answer: "2:3", hint: "Divide both numbers by their greatest common factor.", explanation: "4 √∑ 2 = 2, 6 √∑ 2 = 3. Simplified: 2:3", xp: 10 },
                { difficulty: 2, question: "Simplify the ratio 10:15.", answer: "2:3", hint: "What number divides both 10 and 15?", explanation: "10 √∑ 5 = 2, 15 √∑ 5 = 3. Simplified: 2:3", xp: 10 },
                { difficulty: 2, question: "Are 3:4 and 9:12 equivalent ratios?", answer: "yes", hint: "Multiply both parts of 3:4 by 3. What do you get?", explanation: "3 √ó 3 = 9, 4 √ó 3 = 12. So 3:4 = 9:12. Yes, equivalent.", xp: 10, alternateAnswers: ["yes they are", "they are equivalent"] },
                { difficulty: 2, question: "Find the missing value: 2:5 = ?:15", answer: "6", hint: "5 √ó 3 = 15. Multiply the other part by 3 too.", explanation: "5 √ó 3 = 15, so 2 √ó 3 = 6. The ratio is 6:15.", xp: 10 },
                { difficulty: 2, question: "Find the missing value: 3:7 = 9:?", answer: "21", hint: "3 √ó 3 = 9. What do you do to 7?", explanation: "3 √ó 3 = 9, so 7 √ó 3 = 21. The ratio is 9:21.", xp: 10 },
                { difficulty: 2, question: "Simplify the ratio 8:12.", answer: "2:3", hint: "Divide both by 4.", explanation: "8 √∑ 4 = 2, 12 √∑ 4 = 3. Simplified: 2:3", xp: 10 },
                { difficulty: 2, question: "Simplify the ratio 6:9.", answer: "2:3", hint: "Divide both by 3.", explanation: "6 √∑ 3 = 2, 9 √∑ 3 = 3. Simplified: 2:3", xp: 10 },
                { difficulty: 2, question: "Find the missing value: 5:2 = 25:?", answer: "10", hint: "5 √ó 5 = 25. Apply the same multiplier to 2.", explanation: "5 √ó 5 = 25, so 2 √ó 5 = 10. The ratio is 25:10.", xp: 10 },
                { difficulty: 2, question: "Are 2:5 and 4:10 equivalent ratios?", answer: "yes", hint: "Multiply both parts of 2:5 by 2.", explanation: "2 √ó 2 = 4, 5 √ó 2 = 10. So 2:5 = 4:10. Yes, equivalent.", xp: 10, alternateAnswers: ["yes they are", "they are equivalent"] },
                { difficulty: 2, question: "Simplify the ratio 15:20.", answer: "3:4", hint: "Divide both by 5.", explanation: "15 √∑ 5 = 3, 20 √∑ 5 = 4. Simplified: 3:4", xp: 10 },
                { difficulty: 2, question: "Find the missing value: 4:3 = ?:12", answer: "16", hint: "3 √ó 4 = 12. Multiply the top part by 4 too.", explanation: "3 √ó 4 = 12, so 4 √ó 4 = 16. The ratio is 16:12.", xp: 10 },
                { difficulty: 2, question: "Simplify the ratio 14:21.", answer: "2:3", hint: "Divide both by 7.", explanation: "14 √∑ 7 = 2, 21 √∑ 7 = 3. Simplified: 2:3", xp: 10 },
                { difficulty: 2, question: "Find the missing value: 1:6 = 5:?", answer: "30", hint: "1 √ó 5 = 5. What happens to 6?", explanation: "1 √ó 5 = 5, so 6 √ó 5 = 30. The ratio is 5:30.", xp: 10 },
                { difficulty: 2, question: "Are 5:8 and 10:16 equivalent ratios?", answer: "yes", hint: "Multiply both parts of 5:8 by 2.", explanation: "5 √ó 2 = 10, 8 √ó 2 = 16. Yes, equivalent.", xp: 10, alternateAnswers: ["yes they are", "they are equivalent"] },
                { difficulty: 2, question: "Simplify the ratio 9:12.", answer: "3:4", hint: "Divide both by 3.", explanation: "9 √∑ 3 = 3, 12 √∑ 3 = 4. Simplified: 3:4", xp: 10 },
                { difficulty: 2, question: "Find the missing value: 7:2 = 21:?", answer: "6", hint: "7 √ó 3 = 21. Apply the same multiplier to 2.", explanation: "7 √ó 3 = 21, so 2 √ó 3 = 6. The ratio is 21:6.", xp: 10 },
                { difficulty: 2, question: "Simplify the ratio 20:25.", answer: "4:5", hint: "Divide both by 5.", explanation: "20 √∑ 5 = 4, 25 √∑ 5 = 5. Simplified: 4:5", xp: 10 },
                // --- Difficulty 3: Unit rate and word problems (16 questions) ---
                { difficulty: 3, question: "A car travels 120 miles in 3 hours. What is its speed in miles per hour?", answer: "40", hint: "Divide total miles by total hours to get miles per 1 hour.", explanation: "120 √∑ 3 = 40 miles per hour.", xp: 15 },
                { difficulty: 3, question: "5 apples cost $2.50. How much does 1 apple cost?", answer: "0.50", hint: "Divide the total price by the number of apples.", explanation: "$2.50 √∑ 5 = $0.50 per apple.", xp: 15, alternateAnswers: ["$0.50", "50 cents"] },
                { difficulty: 3, question: "A recipe for 4 people needs 6 cups of flour. How much flour is needed for 1 person?", answer: "1.5", hint: "Divide total flour by number of people.", explanation: "6 √∑ 4 = 1.5 cups per person.", xp: 15, alternateAnswers: ["3/2", "1 1/2"] },
                { difficulty: 3, question: "The ratio of wins to losses is 4:1. Out of 20 games total, how many were wins?", answer: "16", hint: "4 wins + 1 loss = 5 games per cycle. How many cycles in 20 games?", explanation: "20 √∑ 5 = 4 cycles. Wins = 4 √ó 4 = 16.", xp: 15 },
                { difficulty: 3, question: "A map scale is 1 cm = 5 km. If two cities are 8 cm apart on the map, how far apart are they in real life?", answer: "40", hint: "Multiply the map distance by the scale factor.", explanation: "8 cm √ó 5 km/cm = 40 km.", xp: 15 },
                { difficulty: 3, question: "A runner jogs 15 miles in 3 hours. How many miles does she run per hour?", answer: "5", hint: "Divide total distance by total time.", explanation: "15 √∑ 3 = 5 miles per hour.", xp: 15 },
                { difficulty: 3, question: "A store sells 8 notebooks for $12. What is the cost per notebook?", answer: "1.50", hint: "Divide the total cost by the number of notebooks.", explanation: "$12 √∑ 8 = $1.50 per notebook.", xp: 15, alternateAnswers: ["$1.50", "1.5"] },
                { difficulty: 3, question: "The ratio of cats to dogs at a shelter is 3:2. If there are 18 cats, how many dogs are there?", answer: "12", hint: "3:2 means for every 3 cats there are 2 dogs. How many groups of 3 in 18?", explanation: "18 √∑ 3 = 6 groups. Dogs = 6 √ó 2 = 12.", xp: 15 },
                { difficulty: 3, question: "A factory makes 240 parts in 8 hours. How many parts does it make per hour?", answer: "30", hint: "Divide total parts by total hours.", explanation: "240 √∑ 8 = 30 parts per hour.", xp: 15 },
                { difficulty: 3, question: "A map scale is 2 cm = 3 km. Two parks are 10 cm apart on the map. How far apart are they in real life?", answer: "15", hint: "First find km per cm, then multiply by 10.", explanation: "3 km √∑ 2 cm = 1.5 km/cm. 1.5 √ó 10 = 15 km.", xp: 15 },
                { difficulty: 3, question: "The ratio of red to blue paint in a mixture is 2:3. If you use 10 liters of red paint, how many liters of blue do you need?", answer: "15", hint: "2:3 ‚Äî if red is 10, how many groups of 2 is that?", explanation: "10 √∑ 2 = 5 groups. Blue = 5 √ó 3 = 15 liters.", xp: 15 },
                { difficulty: 3, question: "A cyclist rides 56 miles in 4 hours. What is her average speed in miles per hour?", answer: "14", hint: "Divide total distance by total time.", explanation: "56 √∑ 4 = 14 miles per hour.", xp: 15 },
                { difficulty: 3, question: "A bag of 6 oranges costs $3.00. What is the cost per orange?", answer: "0.50", hint: "Divide total cost by number of oranges.", explanation: "$3.00 √∑ 6 = $0.50 per orange.", xp: 15, alternateAnswers: ["$0.50", "50 cents"] },
                { difficulty: 3, question: "In a school, the ratio of students to teachers is 25:1. If there are 10 teachers, how many students are there?", answer: "250", hint: "Multiply the ratio by the number of teachers.", explanation: "25 √ó 10 = 250 students.", xp: 15 },
                { difficulty: 3, question: "A recipe calls for 3 cups of sugar for every 5 cups of flour. How many cups of sugar are needed with 20 cups of flour?", answer: "12", hint: "20 √∑ 5 = 4 groups. Multiply sugar by the same factor.", explanation: "20 √∑ 5 = 4 groups. Sugar = 3 √ó 4 = 12 cups.", xp: 15 },
                { difficulty: 3, question: "A train travels 180 km in 2 hours. What is its speed in km per hour?", answer: "90", hint: "Divide total distance by total time.", explanation: "180 √∑ 2 = 90 km per hour.", xp: 15 },
            ],
        };

        // ‚îÄ‚îÄ‚îÄ Skill hierarchy: one tree per domain, 5 nodes each mapping to QUESTION_BANK difficulty 1-5 ‚îÄ‚îÄ‚îÄ
        const SKILL_TREE = {
            algebra: [
                { id: 'variable-substitution',    name: 'Variables & Substitution',    difficulty: 1,
                  description: 'Reading and evaluating algebraic expressions' },
                { id: 'one-step-equations',       name: 'One-Step Equations',          difficulty: 2,
                  description: 'Solving equations with a single inverse operation' },
                { id: 'two-step-equations',       name: 'Two-Step Equations',          difficulty: 3,
                  description: 'Solving ax ¬± b = c with two inverse operations' },
                { id: 'multi-step-word-problems', name: 'Multi-Step & Word Problems',  difficulty: 4,
                  description: 'Distribution, combining like terms, problem translation' },
                { id: 'variables-both-sides',     name: 'Variables on Both Sides',     difficulty: 5,
                  description: 'Equations requiring consolidation of variable terms' },
            ],
            geometry: [
                { id: 'shape-properties',         name: 'Shape Properties',            difficulty: 1,
                  description: 'Sides, angles, and vocabulary of basic shapes' },
                { id: 'perimeter-area-direct',    name: 'Perimeter & Area',            difficulty: 2,
                  description: 'Computing perimeter and area from given dimensions' },
                { id: 'inverse-dimensions',       name: 'Missing Dimensions',          difficulty: 3,
                  description: 'Finding a side length from perimeter or area' },
                { id: 'multi-step-geometry',      name: 'Multi-Step Geometry',         difficulty: 4,
                  description: 'Combining formulas, algebraic setup, word problems' },
                { id: 'advanced-geometry',        name: 'Advanced Geometry',           difficulty: 5,
                  description: 'Pythagorean theorem, angle equations, compound shapes' },
            ],
            fractions: [
                { id: 'fraction-concepts',        name: 'Fraction Concepts',           difficulty: 1,
                  description: 'Understanding numerator, denominator, and part-whole' },
                { id: 'same-denominator',         name: 'Same-Denominator Arithmetic', difficulty: 2,
                  description: 'Adding and subtracting with matching denominators' },
                { id: 'simplification',           name: 'Simplification & Equivalence',difficulty: 3,
                  description: 'Reducing fractions using GCD, equivalent fractions' },
                { id: 'unlike-denominators',      name: 'Unlike Denominators',         difficulty: 4,
                  description: 'Finding LCM and converting to common denominators' },
                { id: 'multiply-divide',          name: 'Multiply & Divide',           difficulty: 5,
                  description: 'Fraction multiplication, division, complex operations' },
            ],
            ratios: [
                { id: 'ratio-concepts',    name: 'Ratio Concepts',    difficulty: 1, description: 'Understanding what a ratio means and how to write one' },
                { id: 'equivalent-ratios', name: 'Equivalent Ratios', difficulty: 2, description: 'Scaling ratios up and down like equivalent fractions' },
                { id: 'unit-rate',         name: 'Unit Rate',         difficulty: 3, description: 'Finding the rate per one unit' },
            ],
        };

        const STORAGE_KEY = 'rsm-math-quest-v2';

        // djb2 non-cryptographic hash ‚Äî sufficient for localStorage-only child app
        function hashPassword(str) {
            let hash = 5381;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) + hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return (hash >>> 0).toString(16);
        }

        function verifyPassword(input, storedHash) {
            return hashPassword(input) === storedHash;
        }

        // Returns the student's current grade, auto-advancing each school year.
        function getCurrentGrade(user) {
            if (!user?.gradeInfo) return null;
            const yearsElapsed = new Date().getFullYear() - user.gradeInfo.enrollYear;
            return user.gradeInfo.grade + yearsElapsed;
        }

        const ORDINAL = { 5: '5th', 6: '6th', 7: '7th', 8: '8th', 9: '9th' };

        function MathLearningApp() {
            const [users, setUsers] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : [];
                } catch {
                    return [];
                }
            });
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('login');
            const [currentTopic, setCurrentTopic] = useState(null);
            const [currentLesson, setCurrentLesson] = useState(null);
            const [lessonPhase, setLessonPhase] = useState(null);
            const [phaseIndex, setPhaseIndex] = useState(0);
            const [currentProblem, setCurrentProblem] = useState(null);
            const [userAnswer, setUserAnswer] = useState('')
            const [feedback, setFeedback] = useState(null);
            const [showHint, setShowHint] = useState(false);
            const [showTutor, setShowTutor] = useState(false);
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            
            // Discovery dialogue state
            const [discoveryProblemsCompleted, setDiscoveryProblemsCompleted] = useState(0);
            const [awaitingPatternResponse, setAwaitingPatternResponse] = useState(false);
            const [awaitingArticulation, setAwaitingArticulation] = useState(false);
            const [hasArticulated, setHasArticulated] = useState(false);

            // Sufficiency threshold: tutor confirmed student solved it via chat
            const [isProblemSolved, setIsProblemSolved] = useState(false);

            // Adaptive difficulty state
            const [adaptiveDifficulty, setAdaptiveDifficulty] = useState(1);
            const [consecutiveCorrect, setConsecutiveCorrect] = useState(0);
            const [consecutiveWrong, setConsecutiveWrong] = useState(0);
            const [hintUsedOnCurrentProblem, setHintUsedOnCurrentProblem] = useState(false);
            const [warmupQueue, setWarmupQueue] = useState([]);
            const [applicationProblemsShown, setApplicationProblemsShown] = useState(0);
            const seenQuestionsRef = useRef(new Set());

            const canvasRef = useRef(null);
            const chatMessagesRef = useRef(null);

            // Persist all user profiles (stats, XP, badges, streaks) to localStorage
            useEffect(() => {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(users)); }
                catch { /* storage unavailable ‚Äî progress won't survive refresh */ }
            }, [users]);

            // Auth form state
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPassword, setLoginPassword] = useState('');
            const [loginError, setLoginError] = useState('');
            // Shared registration form state (used by both parent and child register views)
            const [regName, setRegName] = useState('');
            const [regUsername, setRegUsername] = useState('');
            const [regPassword, setRegPassword] = useState('');
            const [regParentUsername, setRegParentUsername] = useState('');
            const [regAvatar, setRegAvatar] = useState(AVATARS[0]);
            const [regError, setRegError] = useState('');
            const [regSuccess, setRegSuccess] = useState('');
            const [regGrade, setRegGrade] = useState(6);

            // Build a shuffled warmup pool by mixing the lesson's own warmup questions
            // with QUESTION_BANK difficulty-1 questions for variety each session.

            // Returns the SKILL_TREE node key for the current problem, e.g. "algebra.one-step-equations".
            // QUESTION_BANK problems have an explicit .difficulty; lesson problems infer it from phase.
            function getSkillNodeKey(topic, problem, phase, adaptiveDiff) {
                if (!topic || !SKILL_TREE[topic]) return null;
                const diffLevel = problem.difficulty
                    ?? (phase === 'warmup'      ? 1
                      : phase === 'discovery'   ? 2
                      : phase === 'exitTicket'  ? 3
                      : phase === 'application' ? adaptiveDiff
                      : null);
                if (!diffLevel) return null;
                const node = SKILL_TREE[topic].find(n => n.difficulty === diffLevel);
                return node ? `${topic}.${node.id}` : null;
            }

            // Returns a mastery tier string based on correct/attempted counts.
            function getMasteryLevel(entry) {
                if (!entry || !entry.attempted) return 'not-started';
                const rate = entry.correct / entry.attempted;
                if (entry.correct >= 5 && rate >= 0.70) return 'mastered';
                if (entry.correct >= 3 && rate >= 0.50) return 'practicing';
                if (entry.correct >= 1)                 return 'learning';
                return 'struggling';
            }

            function buildShuffledWarmup(lesson) {
                const bankDiff1 = (QUESTION_BANK[lesson.topic] || []).filter(q => q.difficulty === 1);
                const combined = [...lesson.warmup, ...bankDiff1];
                // Deduplicate by question text
                const seen = new Set();
                const unique = combined.filter(q => {
                    if (seen.has(q.question)) return false;
                    seen.add(q.question);
                    return true;
                });
                // Fisher-Yates shuffle
                for (let i = unique.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [unique[i], unique[j]] = [unique[j], unique[i]];
                }
                return unique.slice(0, 2);
            }

            // Pick a random unseen question from QUESTION_BANK at the target difficulty.
            // Falls back to any unseen question if the difficulty level is exhausted.
            function pickAdaptiveQuestion(topic, difficulty) {
                const seen = seenQuestionsRef.current;
                let pool = (QUESTION_BANK[topic] || []).filter(
                    q => q.difficulty === difficulty && !seen.has(q.question)
                );
                if (pool.length === 0) {
                    pool = (QUESTION_BANK[topic] || []).filter(q => !seen.has(q.question));
                }
                if (pool.length === 0) return null;
                const picked = pool[Math.floor(Math.random() * pool.length)];
                seen.add(picked.question);
                return picked;
            }

            function resetRegForm() {
                setRegName(''); setRegUsername(''); setRegPassword('');
                setRegParentUsername(''); setRegAvatar(AVATARS[0]);
                setRegError(''); setRegSuccess(''); setRegGrade(6);
            }

            function login() {
                const uname = loginUsername.trim().toLowerCase();
                const user = users.find(u => u.username === uname);
                if (!user || !verifyPassword(loginPassword, user.passwordHash)) {
                    setLoginError('Incorrect username or password.');
                    return;
                }
                setLoginError('');
                setLoginUsername('');
                setLoginPassword('');
                if (user.role === 'child' && user.pendingApproval) {
                    setCurrentUser(user);
                    setView('pending-approval');
                    return;
                }
                // Update streak on child login
                let activeUser = user;
                if (user.role === 'child' && user.stats) {
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86_400_000).toDateString();
                    const last = user.lastPlayed;
                    const newStreak = last === today ? user.stats.streak
                        : last === yesterday ? user.stats.streak + 1
                        : 1;
                    activeUser = { ...user, lastPlayed: today, stats: { ...user.stats, streak: newStreak } };
                    setUsers(prev => prev.map(u => u.id === user.id ? activeUser : u));
                }
                setCurrentUser(activeUser);
                setView(activeUser.role === 'parent' ? 'parent' : 'home');
            }

            function registerParent() {
                const name = regName.trim();
                const uname = regUsername.trim().toLowerCase();
                const pass = regPassword;
                if (!name) { setRegError('Display name is required.'); return; }
                if (!uname) { setRegError('Username is required.'); return; }
                if (pass.length < 4) { setRegError('Password must be at least 4 characters.'); return; }
                if (users.some(u => u.username === uname)) { setRegError('That username is already taken.'); return; }
                const newParent = {
                    id: Date.now().toString(),
                    username: uname,
                    passwordHash: hashPassword(pass),
                    role: 'parent',
                    name,
                    avatar: regAvatar,
                    parentId: null,
                    pendingApproval: false,
                    stats: null,
                    badges: [],
                    conceptMastery: {},
                    lastPlayed: null,
                };
                setUsers(prev => [...prev, newParent]);
                resetRegForm();
                setCurrentUser(newParent);
                setView('parent');
            }

            function registerChild() {
                const name = regName.trim();
                const uname = regUsername.trim().toLowerCase();
                const pass = regPassword;
                const puname = regParentUsername.trim().toLowerCase();
                if (!name) { setRegError('Display name is required.'); return; }
                if (!uname) { setRegError('Username is required.'); return; }
                if (pass.length < 4) { setRegError('Password must be at least 4 characters.'); return; }
                if (!puname) { setRegError("Enter your parent's username."); return; }
                if (users.some(u => u.username === uname)) { setRegError('That username is already taken.'); return; }
                const parent = users.find(u => u.username === puname && u.role === 'parent');
                if (!parent) { setRegError("No parent account found with that username."); return; }
                const newChild = {
                    id: Date.now().toString(),
                    username: uname,
                    passwordHash: hashPassword(pass),
                    role: 'child',
                    name,
                    avatar: regAvatar,
                    parentId: parent.id,
                    pendingApproval: true,
                    gradeInfo: { grade: regGrade, enrollYear: new Date().getFullYear() },
                    stats: { xp: 0, level: 1, problemsSolved: 0, streak: 0, accuracy: 100 },
                    badges: [],
                    conceptMastery: {},
                    lastPlayed: null,
                };
                setUsers(prev => [...prev, newChild]);
                resetRegForm();
                setRegSuccess(`Account created! Ask ${parent.name} to log in and approve your profile.`);
            }

            function approveChild(childId) {
                setUsers(prev => prev.map(u => u.id === childId ? { ...u, pendingApproval: false } : u));
            }

            function rejectChild(childId) {
                setUsers(prev => prev.filter(u => u.id !== childId));
            }

            function startLesson(lessonId) {
                const lesson = LESSONS[lessonId];

                // Reset seen-question tracking and build a fresh shuffled warmup
                seenQuestionsRef.current = new Set();
                const queue = buildShuffledWarmup(lesson);
                queue.forEach(q => seenQuestionsRef.current.add(q.question));

                setWarmupQueue(queue);
                setCurrentLesson(lesson);
                setCurrentTopic(lesson.topic);
                setLessonPhase('warmup');
                setPhaseIndex(0);
                setCurrentProblem(queue[0]);
                setAdaptiveDifficulty(1);
                setConsecutiveCorrect(0);
                setConsecutiveWrong(0);
                setHintUsedOnCurrentProblem(false);
                setApplicationProblemsShown(0);
                setView('lesson');
                setUserAnswer('');
                setFeedback(null);
                setShowHint(false);
                setShowTutor(false);
                setChatMessages([]);
                setIsProblemSolved(false);
            }

            function nextProblemInLesson() {
                const lesson = currentLesson;
                const APPLICATION_MAX = 6; // number of adaptive practice problems before exit ticket

                // Per-problem UI resets (shared across all branches)
                setUserAnswer('');
                setFeedback(null);
                setShowHint(false);
                setShowTutor(false);
                setChatMessages([]);
                setIsProblemSolved(false);
                setHintUsedOnCurrentProblem(false);

                if (lessonPhase === 'warmup') {
                    if (phaseIndex + 1 < warmupQueue.length) {
                        setPhaseIndex(phaseIndex + 1);
                        setCurrentProblem(warmupQueue[phaseIndex + 1]);
                    } else {
                        setLessonPhase('discovery');
                        setPhaseIndex(0);
                        setCurrentProblem(lesson.discovery[0]);
                    }
                } else if (lessonPhase === 'discovery') {
                    if (phaseIndex + 1 < lesson.discovery.length) {
                        setPhaseIndex(phaseIndex + 1);
                        setCurrentProblem(lesson.discovery[phaseIndex + 1]);
                    } else {
                        // Discovery complete ‚Üí adaptive application phase
                        setLessonPhase('application');
                        setApplicationProblemsShown(0);
                        setPhaseIndex(0);
                        const firstApp = pickAdaptiveQuestion(lesson.topic, adaptiveDifficulty)
                            || lesson.application[0];
                        setCurrentProblem(firstApp);
                    }
                } else if (lessonPhase === 'application') {
                    const nextShown = applicationProblemsShown + 1;
                    if (nextShown < APPLICATION_MAX) {
                        const nextQ = pickAdaptiveQuestion(lesson.topic, adaptiveDifficulty)
                            || lesson.application[Math.min(phaseIndex + 1, lesson.application.length - 1)];
                        setApplicationProblemsShown(nextShown);
                        setPhaseIndex(nextShown);
                        setCurrentProblem(nextQ);
                    } else if (lesson.exitTicketBridge) {
                        setLessonPhase('exitTicketBridge');
                        setCurrentProblem(null);
                    } else {
                        setLessonPhase('exitTicket');
                        setPhaseIndex(0);
                        setCurrentProblem(lesson.exitTicket[0]);
                    }
                } else if (lessonPhase === 'exitTicket') {
                    if (phaseIndex + 1 < lesson.exitTicket.length) {
                        setPhaseIndex(phaseIndex + 1);
                        setCurrentProblem(lesson.exitTicket[phaseIndex + 1]);
                    } else {
                        setView('lessonComplete');
                    }
                }
            }

            function startTopic(topic) {
                setCurrentTopic(topic);
                setCurrentLesson(null);
                const problems = PROBLEMS[topic];
                if (!problems || problems.length === 0) {
                    const lessonKey = Object.keys(LESSONS).find(k => LESSONS[k].topic === topic);
                    if (lessonKey) {
                        startLesson(lessonKey);
                    }
                    return;
                }
                const randomProblem = problems[Math.floor(Math.random() * problems.length)];
                setCurrentProblem(randomProblem);
                setView('problem');
                setUserAnswer('');
                setFeedback(null);
                setShowHint(false);
                setShowTutor(false);
                setChatMessages([]);
                setIsProblemSolved(false);
            }

            function checkAnswer() {
                const correctAnswers = [currentProblem.answer];
                if (currentProblem.alternateAnswers) {
                    correctAnswers.push(...currentProblem.alternateAnswers);
                }
                
                const isCorrect = correctAnswers.some(ans => 
                    userAnswer.trim().toLowerCase() === ans.toLowerCase()
                );
                
                if (isCorrect) {
                    setFeedback({ correct: true, message: 'Correct! Great job!' });
                    setShowTutor(false); // Auto-close tutor on correct answer
                    setIsProblemSolved(false); // Reset ‚Äî they solved it via answer box
                    
                    // DISCOVERY DIALOGUE TRIGGER
                    if (lessonPhase === 'discovery') {
                        const newCount = discoveryProblemsCompleted + 1;
                        setDiscoveryProblemsCompleted(newCount);
                        
                        // After 2nd correct discovery problem, ask about patterns
                        if (newCount === 2 && !awaitingPatternResponse) {
                            setTimeout(() => {
                                setShowTutor(true);
                                setAwaitingPatternResponse(true);
                                const patternPrompt = "Great work on these two problems! üéØ Before we continue ‚Äî think about HOW you solved them. What operation or method did you use? And why do you think that approach worked for both?";
                                setChatMessages(prev => [...prev, 
                                    { role: 'assistant', content: patternPrompt }
                                ]);
                                if (chatMessagesRef.current) {
                                    chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                                }
                            }, 1000);
                            return; // Don't advance yet
                        }
                    }
                    
                    // Adaptive difficulty: track performance on correct answers.
                    // Difficulty only adjusts during the application phase to avoid
                    // disrupting the fixed discovery sequence.
                    {
                        const noHint = !hintUsedOnCurrentProblem;
                        const newCorrect = noHint ? consecutiveCorrect + 1 : 0;
                        setConsecutiveCorrect(newCorrect);
                        setConsecutiveWrong(0);
                        if (lessonPhase === 'application' && newCorrect >= 2) {
                            setAdaptiveDifficulty(d => Math.min(d + 1, 5));
                            setConsecutiveCorrect(0);
                        }
                    }

                    // ARTICULATION CHECKPOINT (end of Discovery)
                    if (lessonPhase === 'discovery' && !hasArticulated) {
                        const lesson = currentLesson;
                        const discoveryProblems = lesson.discovery;

                        // If this is the last discovery problem, require articulation
                        if (phaseIndex >= discoveryProblems.length - 1) {
                            setTimeout(() => {
                                setShowTutor(true);
                                setAwaitingArticulation(true);
                                const articulationPrompt = "Excellent! You've discovered the pattern. üß† Now, before we move on, I need you to explain the rule in YOUR OWN WORDS. Don't just give me an example - tell me the general rule that works for all problems like these. Why does it work?";
                                setChatMessages(prev => [...prev, 
                                    { role: 'assistant', content: articulationPrompt }
                                ]);
                                if (chatMessagesRef.current) {
                                    chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                                }
                            }, 1000);
                            return; // Block progression until they articulate
                        }
                    }
                    
                    const skillKey = getSkillNodeKey(currentTopic, currentProblem, lessonPhase, adaptiveDifficulty);
                    setUsers(prevUsers => prevUsers.map(u => {
                        if (u.id === currentUser.id) {
                            const newStats = {
                                ...u.stats,
                                xp: u.stats.xp + currentProblem.xp,
                                problemsSolved: u.stats.problemsSolved + 1,
                                level: Math.floor((u.stats.xp + currentProblem.xp) / 100) + 1
                            };
                            const cm = u.conceptMastery || {};
                            const newCM = skillKey ? {
                                ...cm,
                                [skillKey]: {
                                    correct:   (cm[skillKey]?.correct   || 0) + 1,
                                    attempted: (cm[skillKey]?.attempted || 0) + 1,
                                },
                            } : cm;
                            const updatedUser = { ...u, stats: newStats, conceptMastery: newCM };
                            setCurrentUser(updatedUser);
                            return updatedUser;
                        }
                        return u;
                    }));
                } else {
                    setFeedback({ correct: false, message: 'Not quite. Try again!' });

                    // Adaptive difficulty: two consecutive wrong answers in application
                    // eases the difficulty so the student doesn't get stuck.
                    {
                        const newWrong = consecutiveWrong + 1;
                        setConsecutiveWrong(newWrong);
                        setConsecutiveCorrect(0);
                        if (lessonPhase === 'application' && newWrong >= 2) {
                            setAdaptiveDifficulty(d => Math.max(d - 1, 1));
                            setConsecutiveWrong(0);
                        }
                    }

                    // Track wrong attempt in concept mastery so accuracy is reflected
                    const skillKeyWrong = getSkillNodeKey(currentTopic, currentProblem, lessonPhase, adaptiveDifficulty);
                    if (skillKeyWrong) {
                        setUsers(prev => prev.map(u => {
                            if (u.id !== currentUser.id) return u;
                            const cm = u.conceptMastery || {};
                            return { ...u, conceptMastery: {
                                ...cm,
                                [skillKeyWrong]: {
                                    correct:   cm[skillKeyWrong]?.correct   || 0,
                                    attempted: (cm[skillKeyWrong]?.attempted || 0) + 1,
                                },
                            }};
                        }));
                    }

                    // Auto-open tutor and provide guidance
                    if (!showTutor) {
                        setShowTutor(true);
                    }
                    
                    // Add tutor message about the wrong answer
                    const tutorGuidance = identifyMisconception(userAnswer.trim(), currentProblem, currentLesson ? lessonPhase : 'practice');
                    setTimeout(() => {
                        setChatMessages(prev => [...prev, 
                            { role: 'user', content: `I tried ${userAnswer.trim().slice(0, 200)} but it was wrong` },
                            { role: 'assistant', content: tutorGuidance }
                        ]);
                        if (chatMessagesRef.current) {
                            chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                        }
                    }, 500);
                }
            }

            function drawVisualAid() {
                const canvas = canvasRef.current;
                if (!canvas || !currentProblem) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const question = currentProblem.question.toLowerCase();
                
                if (currentTopic === 'geometry') {
                    // Extract dimensions from question
                    const lengthMatch = question.match(/length (\d+)/);
                    const widthMatch = question.match(/width (\d+)/);
                    const sideMatch = question.match(/side (?:of )?(\d+)/);
                    
                    if (question.includes('square') && sideMatch) {
                        // Draw square with actual dimension
                        const side = parseInt(sideMatch[1]);
                        const scale = Math.min(100 / side, 15); // Scale to fit canvas
                        const size = side * scale;
                        
                        ctx.strokeStyle = '#1cb0f6';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(150 - size/2, 50, size, size);
                        
                        // Add dimension labels
                        ctx.font = 'bold 16px Arial';
                        ctx.fillStyle = '#ff4b4b';
                        ctx.fillText(`${side} cm`, 150 - size/2 + size/2 - 20, 50 - 10);
                        ctx.fillText(`${side} cm`, 150 - size/2 - 50, 50 + size/2 + 5);
                        
                        // Add formula hint
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#666';
                        if (question.includes('perimeter')) {
                            ctx.fillText('Perimeter = 4 √ó side', 110, 135);
                        } else if (question.includes('area')) {
                            ctx.fillText('Area = side √ó side', 115, 135);
                        }
                        
                    } else if (question.includes('rectangle') && lengthMatch && widthMatch) {
                        // Draw rectangle with actual dimensions
                        const length = parseInt(lengthMatch[1]);
                        const width = parseInt(widthMatch[1]);
                        const scaleL = Math.min(180 / length, 20);
                        const scaleW = Math.min(90 / width, 20);
                        const scale = Math.min(scaleL, scaleW);
                        
                        const rectWidth = length * scale;
                        const rectHeight = width * scale;
                        
                        ctx.fillStyle = 'rgba(88, 204, 2, 0.1)';
                        ctx.fillRect(200 - rectWidth/2, 60, rectWidth, rectHeight);
                        ctx.strokeStyle = '#1cb0f6';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(200 - rectWidth/2, 60, rectWidth, rectHeight);
                        
                        // Add dimension labels
                        ctx.font = 'bold 16px Arial';
                        ctx.fillStyle = '#ff4b4b';
                        ctx.fillText(`${length} ${question.includes('m') ? 'm' : 'cm'}`, 200 - rectWidth/2 + rectWidth/2 - 15, 50);
                        ctx.fillText(`${width} ${question.includes('m') ? 'm' : 'cm'}`, 200 - rectWidth/2 - 50, 60 + rectHeight/2 + 5);
                        
                        // Add formula hint
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#666';
                        if (question.includes('perimeter')) {
                            ctx.fillText(`Perimeter = 2(${length} + ${width})`, 100, 135);
                        } else if (question.includes('area')) {
                            ctx.fillText(`Area = ${length} √ó ${width}`, 120, 135);
                        }
                        
                    } else if (question.includes('triangle')) {
                        ctx.strokeStyle = '#1cb0f6';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(200, 30);
                        ctx.lineTo(120, 120);
                        ctx.lineTo(280, 120);
                        ctx.closePath();
                        ctx.stroke();
                        
                        // If angles mentioned, show them
                        const angle1 = question.match(/angles? (\d+)/);
                        const angle2 = question.match(/and (\d+)/);
                        if (angle1 && angle2) {
                            ctx.font = 'bold 14px Arial';
                            ctx.fillStyle = '#ff4b4b';
                            ctx.fillText(`${angle1[1]}¬∞`, 130, 110);
                            ctx.fillText(`${angle2[1]}¬∞`, 260, 110);
                            ctx.fillText('?', 195, 45);
                            
                            ctx.font = '13px Arial';
                            ctx.fillStyle = '#666';
                            ctx.fillText('Triangle angles = 180¬∞', 115, 140);
                        }
                    }
                    
                } else if (currentTopic === 'fractions') {
                    // Parse the fraction from the question
                    const fractionMatch = question.match(/(\d+)\/(\d+)/g);
                    
                    if (fractionMatch && fractionMatch.length >= 1) {
                        // Get the denominator (bottom number) - determines how many parts
                        const firstFrac = fractionMatch[0].split('/');
                        const denominator = parseInt(firstFrac[1]);
                        
                        // Draw visual representation
                        if (denominator <= 10) {
                            const boxSize = Math.min(35, 350 / denominator);
                            const startX = 200 - (denominator * boxSize) / 2;
                            
                            // Draw all boxes
                            for (let i = 0; i < denominator; i++) {
                                ctx.strokeStyle = '#1cb0f6';
                                ctx.lineWidth = 2;
                                ctx.strokeRect(startX + i * boxSize, 50, boxSize, boxSize);
                            }
                            
                            // Shade for each fraction in the problem
                            let totalShaded = 0;
                            fractionMatch.forEach((frac, idx) => {
                                const parts = frac.split('/');
                                const numerator = parseInt(parts[0]);
                                
                                // Different colors for different fractions
                                const colors = [
                                    'rgba(28, 176, 246, 0.4)',
                                    'rgba(88, 204, 2, 0.4)',
                                    'rgba(255, 200, 0, 0.4)'
                                ];
                                
                                ctx.fillStyle = colors[idx % colors.length];
                                for (let i = totalShaded; i < totalShaded + numerator && i < denominator; i++) {
                                    ctx.fillRect(startX + i * boxSize + 2, 52, boxSize - 4, boxSize - 4);
                                }
                                
                                totalShaded += numerator;
                            });
                            
                            // Add fraction labels
                            ctx.font = 'bold 16px Arial';
                            ctx.fillStyle = '#3c3c3c';
                            let yPos = 110;
                            fractionMatch.forEach((frac, idx) => {
                                const colors = ['#1cb0f6', '#58cc02', '#ffc800'];
                                ctx.fillStyle = colors[idx % colors.length];
                                ctx.fillText(frac, 30, yPos + idx * 25);
                            });
                            
                            if (question.includes('+')) {
                                ctx.fillStyle = '#3c3c3c';
                                ctx.fillText('+', 80, 110);
                                
                                // Show result hint
                                ctx.font = '14px Arial';
                                ctx.fillStyle = '#666';
                                ctx.fillText(`Add numerators, keep /${denominator}`, 110, 135);
                            }
                        }
                    }
                    
                } else if (currentTopic === 'algebra') {
                    // Parse equation from question
                    const eqMatch = question.match(/(\d*)x\s*([+\-])\s*(\d+)\s*=\s*(\d+)/);
                    
                    if (eqMatch) {
                        const coef = eqMatch[1] ? parseInt(eqMatch[1]) : 1;
                        const op = eqMatch[2];
                        const num = parseInt(eqMatch[3]);
                        const result = parseInt(eqMatch[4]);
                        
                        // Draw balance scale
                        ctx.strokeStyle = '#666';
                        ctx.lineWidth = 2;
                        
                        // Scale beam
                        ctx.beginPath();
                        ctx.moveTo(80, 70);
                        ctx.lineTo(320, 70);
                        ctx.stroke();
                        
                        // Fulcrum
                        ctx.beginPath();
                        ctx.moveTo(200, 70);
                        ctx.lineTo(200, 90);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(180, 90);
                        ctx.lineTo(220, 90);
                        ctx.stroke();
                        
                        // Left side (equation)
                        ctx.fillStyle = '#1cb0f6';
                        ctx.fillRect(100, 35, 40, 30);
                        ctx.font = 'bold 16px Arial';
                        ctx.fillStyle = 'white';
                        ctx.fillText(`${coef > 1 ? coef : ''}x`, 110, 55);
                        
                        if (num > 0) {
                            ctx.fillStyle = op === '+' ? '#58cc02' : '#ff4b4b';
                            ctx.fillRect(145, 35, 35, 30);
                            ctx.fillStyle = 'white';
                            ctx.fillText(`${op}${num}`, 150, 55);
                        }
                        
                        // Right side (result)
                        ctx.fillStyle = '#ffc800';
                        ctx.fillRect(260, 35, 40, 30);
                        ctx.font = 'bold 16px Arial';
                        ctx.fillStyle = 'white';
                        ctx.fillText(result.toString(), 270, 55);
                        
                        // Show hint
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#666';
                        ctx.fillText('Keep the scale balanced!', 120, 120);
                    }
                }
            }

            useEffect(() => {
                if ((view === 'problem' || view === 'lesson') && canvasRef.current) {
                    drawVisualAid();
                }
            }, [currentProblem, view, currentTopic]);

            // Advanced Socratic Dialogue Engine - RSM Framework (offline fallback)
            function getSocraticResponse(studentMessage, conversationHistory) {
                const lowerMessage = studentMessage.toLowerCase();
                const problem = currentProblem;
                const phase = currentLesson ? lessonPhase : 'practice';

                // Scaffold level = number of tutor turns so far (escalate help as it increases)
                const scaffoldLevel = conversationHistory.filter(m => m.role === 'assistant').length;

                // Level 0: First contact ‚Äî orient the student
                if (scaffoldLevel === 0) {
                    return `Let's figure this out together! To start: what information does the problem give you, and what are you being asked to find?`;
                }

                // Student asking for the answer directly
                if (lowerMessage.includes('answer') || lowerMessage.includes('what is it') || lowerMessage.match(/^is it \d+/)) {
                    return `I can't give you the answer ‚Äî that part's yours to discover! Let me ask you this instead: ${getScaffoldQuestion(Math.max(1, scaffoldLevel), problem, phase)}`;
                }

                // Student expresses total confusion or lack of prior knowledge
                if (lowerMessage.includes("don't know") || lowerMessage.includes('no idea') ||
                    lowerMessage.includes('never learned') || lowerMessage.includes('never seen')) {
                    return getFirstPrinciplesExplanation(problem, phase);
                }

                // Student says they're stuck or confused
                if (lowerMessage.includes('stuck') || lowerMessage.includes('confused') ||
                    lowerMessage.includes("don't understand") || lowerMessage.includes('help') ||
                    lowerMessage.includes("can't figure")) {
                    // At higher scaffold levels, go straight to first principles
                    if (scaffoldLevel >= 4) {
                        return getFirstPrinciplesExplanation(problem, phase);
                    }
                    return getScaffoldQuestion(scaffoldLevel, problem, phase);
                }

                // Student asks "why" or "how does this work"
                if (lowerMessage.includes('why') || lowerMessage.includes('how does')) {
                    if (scaffoldLevel < 3) {
                        return `Good question ‚Äî that's the right thing to wonder about! ${problem.hint}. Does that help you see why?`;
                    } else {
                        return getFirstPrinciplesExplanation(problem, phase);
                    }
                }

                // Student mentions a math operation ‚Äî redirect to meaning, not just procedure
                if (lowerMessage.includes('add') || lowerMessage.includes('subtract') ||
                    lowerMessage.includes('multiply') || lowerMessage.includes('divide')) {
                    return `You're thinking about operations ‚Äî good instinct! Now ask yourself: why does that operation make sense for this problem? What would it mean in real life?`;
                }

                // Student made a numerical attempt
                const hasAttempt = /\d+|half|quarter|third|double/.test(lowerMessage);
                if (hasAttempt) {
                    const numberMatch = lowerMessage.match(/\d+/);
                    if (numberMatch) {
                        const studentAnswer = numberMatch[0];
                        const correctAnswers = [problem.answer, ...(problem.alternateAnswers || [])];
                        if (correctAnswers.some(ans => ans.toLowerCase() === studentAnswer)) {
                            // If the student also gave a reason (any explanation alongside the number), mark solved
                            const hasReasoning = lowerMessage.length > (studentAnswer.length + 5) ||
                                /because|since|so|added|subtracted|multipl|divided|sides|top|bottom|times|equal|rule/.test(lowerMessage);
                            if (hasReasoning || scaffoldLevel >= 2) {
                                return `‚úÖ PROBLEM SOLVED! Great job working through that ‚Äî you've got the right answer and the right thinking. You're ready to move on!`;
                            }
                            return `You got ${studentAnswer} ‚Äî nice work! Now the important part: can you explain WHY that's the answer? Walk me through your thinking.`;
                        } else {
                            return identifyMisconception(studentAnswer, problem, phase, scaffoldLevel);
                        }
                    }
                }

                // Student gave an explanation or reasoning (no number, but substantive text)
                const hasSubstantiveText = lowerMessage.split(' ').length >= 6;
                const hasReasoningKeywords = /because|since|you (add|subtract|multipl|divid)|the rule|that means|so i|total|each side|same|equal/.test(lowerMessage);
                if (hasSubstantiveText && hasReasoningKeywords && scaffoldLevel >= 2) {
                    // Treat it as "close enough" ‚Äî praise and move on rather than looping
                    return `That's solid reasoning! I can see you understand the concept. Try entering your answer in the answer box to confirm it ‚Äî you're on the right track.`;
                }

                // Default: continue scaffolding ‚Äî but never repeat level 0 question
                return getScaffoldQuestion(Math.max(1, scaffoldLevel), problem, phase);
            }

            function getScaffoldQuestion(level, problem, phase) {
                const hint = problem.hint;

                switch(level) {
                    case 1: // Orient: what does the problem tell us?
                        return `Let's start simple. What does this problem tell you? What facts do you have to work with?`;

                    case 2: // Simplify: try a smaller version
                        return `Sometimes it helps to try a smaller, simpler version first. ${hint} ‚Äî can you start there?`;

                    case 3: // Compare / look for patterns
                        if (phase === 'discovery') {
                            return `Compare this problem to the last one you solved. What's the same? What changed? What do you notice?`;
                        } else {
                            return `Here's something to focus on: ${hint}. What would you do first using that idea?`;
                        }

                    case 4: // Represent it visually
                        if (problem.question.includes('rectangle') || problem.question.includes('square') || problem.question.includes('perimeter') || problem.question.includes('area')) {
                            return `Try sketching it ‚Äî draw the shape and write in the numbers you know. What does the picture tell you?`;
                        } else if (problem.question.toLowerCase().includes('fraction')) {
                            return `Picture it in your head ‚Äî imagine a pizza or a chocolate bar cut into equal pieces. ${hint}. What does that look like?`;
                        } else {
                            return `Let's make it concrete. Can you draw or write out what you know, step by step? ${hint}`;
                        }

                    case 5: // Show the first step, student continues
                        const firstStep = problem.explanation ? problem.explanation.split('‚Üí')[0] : hint;
                        return `Let me show you just the first move: ${firstStep}. From there ‚Äî what do you think comes next?`;

                    default: // First principles or worked example
                        return getFirstPrinciplesExplanation(problem, phase);
                }
            }

            function getFirstPrinciplesExplanation(problem, phase) {
                const q = problem.question.toLowerCase();

                // Geometry: perimeter
                if (q.includes('perimeter')) {
                    return `Let's go back to basics. Perimeter means the total distance all the way around the outside of a shape ‚Äî like the length of a fence surrounding a yard. If you walked along every edge and added up all the lengths, that's the perimeter. Now look at the problem: what are the side lengths, and how would you add them all up?`;
                }

                // Geometry: area
                if (q.includes('area')) {
                    return `Let's think about what area means. Area is the amount of space inside a shape ‚Äî like how many square tiles would cover a floor. For a rectangle, you find it by multiplying the length by the width (because you're counting rows of tiles). Look at the numbers in this problem: can you use that idea?`;
                }

                // Fractions: addition/subtraction with same denominator
                if (q.includes('fraction') || q.includes('/')) {
                    if (q.includes('+') || q.includes('add')) {
                        return `Let's think about what a fraction actually means. The bottom number tells you how many equal pieces something is cut into. The top number tells you how many pieces you have. When the bottom numbers are the same, you can just add the top numbers ‚Äî the pieces are the same size, so you just count more of them. Can you try that with this problem?`;
                    }
                    return `Fractions can be tricky, so let's start from the beginning. The bottom number (denominator) tells you how many equal pieces you've cut something into. The top number (numerator) tells you how many of those pieces you have. So 3/4 means "cut into 4 pieces, take 3 of them." With that in mind ‚Äî what is this problem asking you to do?`;
                }

                // Algebra / equations
                if (q.includes('x') || q.includes('equation') || q.includes('solve for') || q.includes('variable')) {
                    return `Let's think about equations like a balance scale. Whatever's on the left side must weigh the same as the right side ‚Äî they're equal. If you add or remove the same thing from both sides, the scale stays balanced. That's how we "solve" ‚Äî we do the same thing to both sides until x is alone. What could you do to both sides of this equation to start getting x by itself?`;
                }

                // Multiplication / patterns
                if (q.includes('multipl') || q.includes('times') || q.includes('product')) {
                    return `Let's think about what multiplication really means. 4 √ó 3 means "4 groups of 3" ‚Äî which is the same as 3 + 3 + 3 + 3 = 12. It's a shortcut for repeated addition. With that in mind, what are the two numbers in this problem, and what does multiplying them together actually mean in terms of groups?`;
                }

                // Generic first-principles fallback
                return `Let's slow down and build this up from scratch. ${problem.hint} ‚Äî start with just that idea, using the smallest numbers you can. Then we'll apply the same thinking to the actual problem. What do you get when you try it small first?`;
            }

            function identifyMisconception(wrongAnswer, problem, phase, scaffoldLevel) {
                const wrong = wrongAnswer;
                const q = problem.question.toLowerCase();

                // Perimeter problem, student gave area
                if (q.includes('perimeter') && (q.includes('rectangle') || q.includes('square'))) {
                    const l = (problem.question.match(/length\s*(\d+)/i) || [])[1];
                    const w = (problem.question.match(/width\s*(\d+)/i) || [])[1];
                    if (l && w && wrong == parseInt(l) * parseInt(w)) {
                        return `I got a different answer. You found ${wrong} ‚Äî that's actually the area (length √ó width). But perimeter means going all the way around the outside. Think of it like the fence around a yard: you'd need to count all four sides. Can you add up all the sides instead?`;
                    }
                    return `I got a different answer. Perimeter means the total distance around all the edges ‚Äî like a fence around the outside. ${problem.hint}. Try adding up each side and see what you get.`;
                }

                // Area problem, student gave perimeter
                if (q.includes('area') && (q.includes('rectangle') || q.includes('square'))) {
                    const l = (problem.question.match(/length\s*(\d+)/i) || [])[1];
                    const w = (problem.question.match(/width\s*(\d+)/i) || [])[1];
                    if (l && w && wrong == 2 * (parseInt(l) + parseInt(w))) {
                        return `I got a different answer. You found ${wrong} ‚Äî that's actually the perimeter (going around the outside). Area is different: it's the space inside the shape, like how many tiles cover the floor. To find it, multiply the length by the width. Can you try that?`;
                    }
                    return `I got a different answer. Area is the space inside the shape ‚Äî find it by multiplying length √ó width. ${problem.hint}. Give it another try!`;
                }

                // Fraction addition ‚Äî common mistake: adding denominators
                if (q.includes('fraction') || q.match(/\d+\/\d+/)) {
                    if (q.includes('+')) {
                        // Check if they added the denominators (e.g., 1/4 + 1/4 ‚Üí 2/8 instead of 2/4)
                        if (wrong.includes('/')) {
                            return `I got a different answer. A common mistake when adding fractions is adding both the top AND bottom numbers ‚Äî but we only add the top numbers (numerators). The bottom number (denominator) stays the same because the piece size doesn't change. Try again, keeping the bottom number the same!`;
                        }
                        return `Hmm, I got something different. When adding fractions with the same bottom number, just add the top numbers and keep the bottom number as-is. ${problem.hint}. Want to try once more?`;
                    }
                }

                // Algebra: off-by-one or wrong operation
                if (q.includes('x') || q.includes('solve')) {
                    return `I got a different answer. Remember ‚Äî equations are like a balance scale. Whatever you do to one side, you must do to the other. Check each step: did you do the same thing to both sides? ${problem.hint}`;
                }

                // Generic: escalate if already tried before
                if (scaffoldLevel >= 3) {
                    return getFirstPrinciplesExplanation(problem, phase);
                }
                return `I got a different answer ‚Äî let me ask you this: ${problem.hint}. Try working through it step by step using that clue. What do you get?`;
            }

            async function sendTutorMessage(message) {
                if (!message.trim()) return;
                
                const userMessage = { role: 'user', content: message };
                setChatMessages(prev => [...prev, userMessage]);
                setChatInput('');
                setIsTyping(true);

                try {
                    // Build conversation history
                    const conversationHistory = chatMessages.map(msg => ({
                        role: msg.role === 'assistant' ? 'assistant' : 'user',
                        content: msg.content
                    }));
                    
                    // Add current message
                    conversationHistory.push({
                        role: 'user',
                        content: message
                    });

                    // Build structured request for server-side prompt construction
                    // (system prompts are now constructed on the server to prevent prompt injection)
                    let promptType;
                    let promptContext;

                    if (awaitingPatternResponse) {
                        promptType = 'pattern_recognition';
                        promptContext = {
                            studentMessage: message,
                            lessonPhase: lessonPhase,
                            lessonName: currentLesson?.title || '',
                            ruleToDiscover: currentLesson?.ruleToDiscover || '',
                            problem1: currentLesson?.discovery?.[0]?.question || '',
                            problem2: currentLesson?.discovery?.[1]?.question || '',
                        };
                    } else if (awaitingArticulation) {
                        promptType = 'articulation';
                        promptContext = {
                            studentMessage: message,
                            lessonName: currentLesson?.title || '',
                            problemExplanation: currentProblem.explanation || '',
                        };
                    } else {
                        promptType = 'tutoring';
                        promptContext = {
                            problemQuestion: currentProblem.question || '',
                            problemAnswer: currentProblem.answer || '',
                            problemHint: currentProblem.hint || '',
                            problemExplanation: currentProblem.explanation || '',
                            lessonPhase: currentLesson ? lessonPhase : 'practice',
                            lessonName: currentLesson?.title || '',
                        };
                    }

                    const apiUrl = window.location.hostname === 'localhost' 
                        ? 'http://localhost:3000/api/tutor'
                        : '/api/tutor';

                    const response = await fetch(apiUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            messages: conversationHistory,
                            promptType: promptType,
                            context: promptContext,
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Backend error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.content && data.content[0]) {
                        const tutorResponse = data.content[0].text;
                        const assistantMessage = { role: 'assistant', content: tutorResponse };
                        setChatMessages(prev => [...prev, assistantMessage]);
                        
                        // HANDLE VALIDATION RESULTS
                        const responseLC = tutorResponse.toLowerCase();
                        
                        if (awaitingPatternResponse) {
                            // If AI confirmed pattern with checkmark, they got it
                            if (tutorResponse.includes("‚úÖ") || responseLC.includes("pattern identified")) {
                                setAwaitingPatternResponse(false);
                                setTimeout(() => {
                                    setFeedback(null);
                                    setUserAnswer('');
                                }, 1500);
                            }
                        }

                        // Sufficiency threshold: tutor confirmed the student solved it via chat
                        if (!awaitingPatternResponse && !awaitingArticulation) {
                            if (tutorResponse.includes("‚úÖ PROBLEM SOLVED")) {
                                setIsProblemSolved(true);
                            }
                        }

                        if (awaitingArticulation) {
                            // If AI confirmed understanding with checkmark
                            if (tutorResponse.includes("‚úÖ") || responseLC.includes("understanding confirmed")) {
                                setAwaitingArticulation(false);
                                setHasArticulated(true);
                                setTimeout(() => {
                                    // Articulation always ends the discovery phase ‚Äî advance to application
                                    const lesson = currentLesson;
                                    const firstApp = pickAdaptiveQuestion(lesson.topic, adaptiveDifficulty)
                                        || lesson.application[0];
                                    setLessonPhase('application');
                                    setApplicationProblemsShown(0);
                                    setPhaseIndex(0);
                                    setCurrentProblem(firstApp);
                                    setDiscoveryProblemsCompleted(0);
                                    setFeedback(null);
                                    setUserAnswer('');
                                    setShowTutor(false);
                                }, 2000);
                            }
                        }
                    } else {
                        throw new Error('Invalid response from backend');
                    }
                    
                    setIsTyping(false);
                    
                    if (chatMessagesRef.current) {
                        chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                    }
                } catch (error) {
                    console.error('Tutor error:', error);

                    // Fallback to rule-based tutor
                    const fallbackResponse = getSocraticResponse(message, chatMessages);
                    const assistantMessage = {
                        role: 'assistant',
                        content: `[AI tutor offline - using backup]\n\n${fallbackResponse}`
                    };
                    setChatMessages(prev => [...prev, assistantMessage]);

                    // Check sufficiency threshold in fallback path too
                    if (fallbackResponse.includes("‚úÖ PROBLEM SOLVED")) {
                        setIsProblemSolved(true);
                    }

                    setIsTyping(false);
                }
            }

            useEffect(() => {
                if (chatMessagesRef.current) {
                    chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                }
            }, [chatMessages]);

            // Allow Enter to advance to the next problem once the student has succeeded,
            // but not during discovery gates that block progression.
            useEffect(() => {
                const canAdvance = (feedback?.correct || isProblemSolved)
                    && !awaitingPatternResponse
                    && !awaitingArticulation;
                if (!canAdvance) return;

                const handleKeyDown = (e) => {
                    if (e.key !== 'Enter') return;
                    if (currentLesson) nextProblemInLesson();
                    else startTopic(currentTopic);
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [feedback?.correct, isProblemSolved, awaitingPatternResponse, awaitingArticulation]);

            // RENDER FUNCTIONS - Defined outside to prevent recreation
            const renderLogin = () => (
                <div className="login-container">
                    <h1 className="login-title">RSM Math Quest</h1>
                    <p className="login-subtitle">Sign in to continue learning</p>

                    <div className="login-form">
                        {loginError && <div className="login-error">{loginError}</div>}

                        <label className="form-label">Username</label>
                        <input
                            className="answer-input"
                            type="text"
                            placeholder="Enter your username"
                            value={loginUsername}
                            onChange={e => { setLoginUsername(e.target.value); setLoginError(''); }}
                            onKeyDown={e => e.key === 'Enter' && login()}
                            autoFocus
                            autoComplete="username"
                        />

                        <label className="form-label">Password</label>
                        <input
                            className="answer-input"
                            type="password"
                            placeholder="Enter your password"
                            value={loginPassword}
                            onChange={e => { setLoginPassword(e.target.value); setLoginError(''); }}
                            onKeyDown={e => e.key === 'Enter' && login()}
                            autoComplete="current-password"
                        />

                        <button className="btn-primary" style={{ width: '100%' }} onClick={login}>
                            Log In
                        </button>

                        <div className="login-links">
                            <p>New here?</p>
                            <div className="login-links-row">
                                <button className="link-btn" onClick={() => { resetRegForm(); setView('register-parent'); }}>
                                    Create parent account
                                </button>
                                <span style={{ color: 'var(--text-tertiary)' }}>¬∑</span>
                                <button className="link-btn" onClick={() => { resetRegForm(); setView('register-child'); }}>
                                    Register as student
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderRegisterParent = () => (
                <div className="login-container">
                    <h1 className="login-title">RSM Math Quest</h1>
                    <p className="login-subtitle">Create a parent account</p>
                    <div className="login-form">
                        {regError && <div className="login-error">{regError}</div>}

                        <label className="form-label">Your Name</label>
                        <input className="answer-input" type="text" placeholder="e.g. Jane Smith"
                            value={regName} onChange={e => { setRegName(e.target.value); setRegError(''); }}
                            maxLength={40} autoFocus />

                        <label className="form-label">Username</label>
                        <input className="answer-input" type="text" placeholder="Choose a username"
                            value={regUsername} onChange={e => { setRegUsername(e.target.value); setRegError(''); }}
                            maxLength={30} autoComplete="username" />

                        <label className="form-label">Password</label>
                        <input className="answer-input" type="password" placeholder="At least 4 characters"
                            value={regPassword} onChange={e => { setRegPassword(e.target.value); setRegError(''); }}
                            maxLength={100} autoComplete="new-password"
                            onKeyDown={e => e.key === 'Enter' && registerParent()} />

                        <label className="form-label">Avatar</label>
                        <div className="avatar-picker">
                            {AVATARS.map(av => (
                                <button key={av.name}
                                    className={`avatar-option${regAvatar.name === av.name ? ' selected' : ''}`}
                                    onClick={() => setRegAvatar(av)} title={av.name}>
                                    {av.emoji}
                                </button>
                            ))}
                        </div>

                        <div className="form-actions">
                            <button className="btn-primary" onClick={registerParent}>Create Account</button>
                            <button className="btn-secondary" onClick={() => { resetRegForm(); setView('login'); }}>Back</button>
                        </div>
                    </div>
                </div>
            );

            const renderRegisterChild = () => (
                <div className="login-container">
                    <h1 className="login-title">RSM Math Quest</h1>
                    <p className="login-subtitle">Create a student account</p>
                    <div className="login-form">
                        {regError && <div className="login-error">{regError}</div>}
                        {regSuccess && (
                            <div style={{ background: '#d1fae5', color: '#065f46', border: '1px solid #6ee7b7',
                                borderRadius: '10px', padding: '12px 16px', marginBottom: '16px', fontWeight: 500 }}>
                                {regSuccess}
                                <div style={{ marginTop: '10px' }}>
                                    <button className="link-btn" onClick={() => { resetRegForm(); setView('login'); }}>
                                        Back to login
                                    </button>
                                </div>
                            </div>
                        )}
                        {!regSuccess && (<>
                            <label className="form-label">Your Name</label>
                            <input className="answer-input" type="text" placeholder="e.g. Alex"
                                value={regName} onChange={e => { setRegName(e.target.value); setRegError(''); }}
                                maxLength={40} autoFocus />

                            <label className="form-label">Username</label>
                            <input className="answer-input" type="text" placeholder="Choose a username"
                                value={regUsername} onChange={e => { setRegUsername(e.target.value); setRegError(''); }}
                                maxLength={30} autoComplete="username" />

                            <label className="form-label">Password</label>
                            <input className="answer-input" type="password" placeholder="At least 4 characters"
                                value={regPassword} onChange={e => { setRegPassword(e.target.value); setRegError(''); }}
                                maxLength={100} autoComplete="new-password" />

                            <label className="form-label">Parent's Username</label>
                            <input className="answer-input" type="text" placeholder="Ask your parent for their username"
                                value={regParentUsername} onChange={e => { setRegParentUsername(e.target.value); setRegError(''); }}
                                maxLength={30}
                                onKeyDown={e => e.key === 'Enter' && registerChild()} />

                            <label className="form-label">Avatar</label>
                            <div className="avatar-picker">
                                {AVATARS.map(av => (
                                    <button key={av.name}
                                        className={`avatar-option${regAvatar.name === av.name ? ' selected' : ''}`}
                                        onClick={() => setRegAvatar(av)} title={av.name}>
                                        {av.emoji}
                                    </button>
                                ))}
                            </div>

                            <label className="form-label">Current Grade</label>
                            <div className="grade-picker">
                                {[5, 6, 7, 8].map(g => (
                                    <button key={g}
                                        className={`grade-btn${regGrade === g ? ' active' : ''}`}
                                        onClick={() => setRegGrade(g)}>
                                        {ORDINAL[g]}
                                    </button>
                                ))}
                            </div>

                            <div className="form-actions">
                                <button className="btn-primary" onClick={registerChild}>Request Account</button>
                                <button className="btn-secondary" onClick={() => { resetRegForm(); setView('login'); }}>Back</button>
                            </div>
                        </>)}
                    </div>
                </div>
            );

            const renderPendingApproval = () => (
                <div className="login-container">
                    <div className="pending-card">
                        <div className="pending-icon">‚è≥</div>
                        <h2 style={{ marginBottom: '12px' }}>Waiting for Approval</h2>
                        <p style={{ color: 'var(--text-secondary)', lineHeight: 1.6, marginBottom: '28px' }}>
                            Your account is waiting for your parent to approve it.
                            Ask your parent to log in and approve your profile from their dashboard.
                        </p>
                        <button className="btn-secondary" onClick={() => { setCurrentUser(null); setView('login'); }}>
                            Back to Login
                        </button>
                    </div>
                </div>
            );

            const renderHome = () => {
                if (!currentUser || !currentUser.stats) return null;
                
                return (
                    <div>
                        <div className="header">
                            <div className="header-left">
                                <h1>Hi, {currentUser.name}!</h1>
                                <p>Level {currentUser.stats.level} ¬∑ {currentUser.stats.xp} XP{getCurrentGrade(currentUser) ? ` ¬∑ ${ORDINAL[getCurrentGrade(currentUser)] ?? getCurrentGrade(currentUser) + 'th'} Grade` : ''}</p>
                            </div>
                            <div className="header-stats">
                                <div className="stat-item">
                                    <span className="stat-icon">üî•</span>
                                    <span className="stat-value">{currentUser.stats.streak}</span>
                                </div>
                                <div className="stat-item">
                                    <span className="stat-icon">üéØ</span>
                                    <span className="stat-value">{currentUser.stats.problemsSolved}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="content">
                            <button className="btn-secondary" onClick={() => { setCurrentUser(null); setView('login'); }}>
                                Sign Out
                            </button>

                            <h2 style={{ marginTop: '30px', marginBottom: '20px' }}>Lessons (RSM Style)</h2>

                            <div className="topic-grid">
                                <div className="topic-card" onClick={() => startLesson('fractions-lesson-1')}>
                                    <div className="topic-icon">üçï</div>
                                    <div className="topic-title">Fractions 1</div>
                                    <p>Adding Same Denominator</p>
                                    <span className="grade-badge">Grade 5</span>
                                </div>
                                <div className="topic-card" onClick={() => startLesson('fractions-lesson-2')}>
                                    <div className="topic-icon">‚úñÔ∏è</div>
                                    <div className="topic-title">Fractions 2</div>
                                    <p>Multiplying Fractions</p>
                                    <span className="grade-badge">Grade 5‚Äì6</span>
                                </div>
                                <div className="topic-card" onClick={() => startLesson('geometry-lesson-1')}>
                                    <div className="topic-icon">üìè</div>
                                    <div className="topic-title">Geometry 1</div>
                                    <p>Perimeter & Area</p>
                                    <span className="grade-badge">Grade 5‚Äì6</span>
                                </div>
                                <div className="topic-card" onClick={() => startLesson('ratios-lesson-1')}>
                                    <div className="topic-icon">‚öñÔ∏è</div>
                                    <div className="topic-title">Ratios 1</div>
                                    <p>Introduction to Ratios</p>
                                    <span className="grade-badge">Grade 6</span>
                                </div>
                                <div className="topic-card" onClick={() => startLesson('geometry-lesson-2')}>
                                    <div className="topic-icon">üìê</div>
                                    <div className="topic-title">Geometry 2</div>
                                    <p>Area of Triangles</p>
                                    <span className="grade-badge">Grade 6</span>
                                </div>
                                <div className="topic-card" onClick={() => startLesson('algebra-lesson-1')}>
                                    <div className="topic-icon">üî¢</div>
                                    <div className="topic-title">Algebra 1</div>
                                    <p>One-Step Equations</p>
                                    <span className="grade-badge">Grade 6‚Äì7</span>
                                </div>
                                <div className="topic-card" onClick={() => startLesson('algebra-lesson-2')}>
                                    <div className="topic-icon">üßÆ</div>
                                    <div className="topic-title">Algebra 2</div>
                                    <p>Two-Step Equations</p>
                                    <span className="grade-badge">Grade 6‚Äì7</span>
                                </div>
                            </div>

                            <h2 style={{ marginTop: '40px', marginBottom: '20px' }}>Practice Mode</h2>

                            <div className="topic-grid">
                                <div className="topic-card" onClick={() => startTopic('algebra')}>
                                    <div className="topic-icon">üî¢</div>
                                    <div className="topic-title">Algebra</div>
                                    <p>Random Problems</p>
                                </div>
                                <div className="topic-card" onClick={() => startTopic('geometry')}>
                                    <div className="topic-icon">üìè</div>
                                    <div className="topic-title">Geometry</div>
                                    <p>Random Problems</p>
                                </div>
                                <div className="topic-card" onClick={() => startTopic('fractions')}>
                                    <div className="topic-icon">üçï</div>
                                    <div className="topic-title">Fractions</div>
                                    <p>Random Problems</p>
                                </div>
                                <div className="topic-card" onClick={() => startTopic('ratios')}>
                                    <div className="topic-icon">‚öñÔ∏è</div>
                                    <div className="topic-title">Ratios</div>
                                    <p>Random Problems</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderProblem = () => {
                if (!currentProblem) return null;
                
                return (
                    <div>
                        <div className="header">
                            <div className="header-left">
                                <h1>Solve It!</h1>
                            </div>
                            <div className="header-stats">
                                <div className="stat-item">
                                    <span className="stat-icon">‚≠ê</span>
                                    <span className="stat-value">{currentProblem.xp} XP</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="content">
                            <button className="btn-secondary" onClick={() => setView('home')}>
                                Back
                            </button>
                            
                            <div className="problem-container">
                                <div className="problem-card">
                                    <div className="problem-text">{currentProblem.question}</div>
                                    
                                    {(currentTopic === 'geometry' || currentTopic === 'fractions' || currentTopic === 'algebra') && (
                                        <div className="visual-aid">
                                            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>
                                                Visual Guide
                                            </h3>
                                            <canvas ref={canvasRef} width="400" height="150"></canvas>
                                        </div>
                                    )}
                                    
                                    <input
                                        type="text"
                                        className="answer-input"
                                        value={userAnswer}
                                        onChange={(e) => setUserAnswer(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && !feedback?.correct && checkAnswer()}
                                        placeholder="Type your answer..."
                                        disabled={feedback?.correct}
                                    />
                                    
                                    <div style={{ marginBottom: '20px' }}>

                                    
                                        {!feedback?.correct && (

                                    
                                            <>

                                    
                                                <button className="btn-primary" onClick={checkAnswer}>

                                    
                                                    Check Answer

                                    
                                                </button>

                                    
                                                {' '}

                                    
                                                <button className="btn-hint" onClick={() => { if (!showHint) setHintUsedOnCurrentProblem(true); setShowHint(!showHint); }}>

                                    
                                                    {showHint ? 'Hide' : 'Show'} Hint

                                    
                                                </button>

                                    
                                                {' '}

                                    
                                            </>

                                    
                                        )}

                                    
                                        <button className="btn-tutor" onClick={() => setShowTutor(!showTutor)}>

                                    
                                            {showTutor ? 'Close' : 'Open'} AI Tutor

                                    
                                        </button>

                                    
                                    </div>
                                    
                                    {showHint && !feedback?.correct && (
                                        <div className="hint-box">
                                            <strong>Hint:</strong> {currentProblem.hint}
                                        </div>
                                    )}
                                    
                                    {showTutor && (
                                        <div className="chat-container">
                                            <div className="chat-header">
                                                <span style={{ fontSize: '1.5em' }}>ü§ñ</span>
                                                <strong>AI Math Tutor</strong>
                                                <button 
                                                    style={{ marginLeft: 'auto', padding: '5px 10px', fontSize: '0.8em' }}
                                                    className="btn-secondary"
                                                    onClick={() => setShowTutor(false)}
                                                >
                                                    Close
                                                </button>
                                            </div>
                                            <div className="chat-messages" ref={chatMessagesRef}>
                                                {chatMessages.length === 0 && (
                                                    <div className="chat-message assistant">
                                                        Hi! I'm your RSM math tutor. I'll help you discover the answer through guided questions - I won't just give it to you. What would you like to explore about this problem?
                                                    </div>
                                                )}
                                                {chatMessages.map((msg, idx) => (
                                                    <div key={idx} className={`chat-message ${msg.role}`}>
                                                        {msg.content}
                                                    </div>
                                                ))}
                                                {isTyping && (
                                                    <div className="typing-indicator">
                                                        <div className="typing-dots">
                                                            <div className="typing-dot"></div>
                                                            <div className="typing-dot"></div>
                                                            <div className="typing-dot"></div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            {isProblemSolved ? (
                                                <div style={{ padding: '16px', textAlign: 'center', background: '#f0fff4', borderTop: '2px solid #58cc02', borderRadius: '0 0 14px 14px' }}>
                                                    <p style={{ color: '#3a7a4e', fontWeight: 'bold', marginBottom: '12px' }}>Great work! You've solved this one.</p>
                                                    <button className="btn-primary" onClick={() => startTopic(currentTopic)}>
                                                        Next Problem ‚Üí
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="chat-input-container">
                                                    <input
                                                        type="text"
                                                        className="chat-input"
                                                        value={chatInput}
                                                        onChange={(e) => setChatInput(e.target.value)}
                                                        onKeyPress={(e) => {
                                                            if (e.key === 'Enter' && !isTyping) {
                                                                sendTutorMessage(chatInput);
                                                                setTimeout(() => e.target.focus(), 100);
                                                            }
                                                        }}
                                                        placeholder="Ask the tutor..."
                                                        disabled={isTyping}
                                                        autoFocus
                                                    />
                                                    <button
                                                        className="chat-send"
                                                        onClick={() => sendTutorMessage(chatInput)}
                                                        disabled={isTyping || !chatInput.trim()}
                                                    >
                                                        Send
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {feedback && (
                                        <div className={`feedback ${feedback.correct ? 'correct' : 'incorrect'}`}>
                                            {feedback.message}
                                            {feedback.correct && currentProblem.explanation && (
                                                <div style={{ marginTop: '15px', fontSize: '0.95em' }}>
                                                    <strong>Explanation:</strong> {currentProblem.explanation}
                                                </div>
                                            )}
                                            {feedback.correct && (
                                                <div style={{ marginTop: '20px' }}>
                                                    <button className="btn-primary" onClick={() => startTopic(currentTopic)}>
                                                        Next Problem
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderLesson = () => {
                if (!currentLesson) return null;

                // Bridge screen shown between application and exit ticket
                if (lessonPhase === 'exitTicketBridge') {
                    const bridge = currentLesson.exitTicketBridge;
                    return (
                        <div>
                            <div className="header">
                                <div className="header-left">
                                    <h1>{currentLesson.title}</h1>
                                    <p>Phase: Exit Ticket</p>
                                </div>
                            </div>
                            <div className="content">
                                <button className="btn-secondary" onClick={() => setView('home')}>
                                    Back to Home
                                </button>
                                <div className="bridge-card">
                                    <div className="bridge-badge">New Concept</div>
                                    <h2>{bridge.concept}</h2>
                                    <p>{bridge.explanation}</p>
                                    <div className="bridge-example">
                                        <div className="bridge-problem">{bridge.example.problem}</div>
                                        <div className="bridge-steps">
                                            {bridge.example.steps.map((s, i) => (
                                                <div key={i} className="bridge-step">
                                                    <span className="bridge-step-num">{i + 1}</span>
                                                    <span>{s}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="bridge-answer">Answer: {bridge.example.answer}</div>
                                    </div>
                                    <div className="bridge-actions">
                                        <button className="btn-primary" onClick={() => {
                                            setLessonPhase('exitTicket');
                                            setPhaseIndex(0);
                                            setCurrentProblem(currentLesson.exitTicket[0]);
                                            setFeedback(null);
                                            setUserAnswer('');
                                            setShowTutor(false);
                                        }}>
                                            Try the Exit Ticket
                                        </button>
                                        <button className="btn-secondary" onClick={() => setView('lessonComplete')}>
                                            Finish Lesson
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }

                if (!currentProblem) return null;

                const phaseNames = {
                    'warmup': 'Warm-Up',
                    'discovery': 'Discovery',
                    'application': 'Application',
                    'exitTicket': 'Exit Ticket',
                    'exitTicketBridge': 'Exit Ticket',
                };

                const progress = lessonPhase === 'application' ? applicationProblemsShown + 1 : phaseIndex + 1;
                const total = lessonPhase === 'application' ? 6
                    : lessonPhase === 'warmup' ? (warmupQueue.length || currentLesson.warmup.length)
                    : currentLesson[lessonPhase]?.length ?? 0;

                const isExitTicketActive = lessonPhase === 'exitTicket' || lessonPhase === 'exitTicketBridge';

                return (
                    <div>
                        <div className="header">
                            <div className="header-left">
                                <h1>{currentLesson.title}</h1>
                                <p>Phase: {phaseNames[lessonPhase]} ({progress}/{total})</p>
                            </div>
                            <div className="header-stats">
                                <div className="stat-item">
                                    <span className="stat-icon">‚≠ê</span>
                                    <span className="stat-value">{currentProblem.xp} XP</span>
                                </div>
                            </div>
                        </div>

                        <div className="content">
                            <button className="btn-secondary" onClick={() => setView('home')}>
                                Back
                            </button>

                            <div style={{
                                background: '#f0f0f0',
                                borderRadius: '10px',
                                padding: '20px',
                                marginTop: '20px',
                                marginBottom: '20px'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                    <span style={{
                                        fontWeight: lessonPhase === 'warmup' ? 'bold' : 'normal',
                                        color: lessonPhase === 'warmup' ? 'var(--primary)' : '#666'
                                    }}>Warm-Up</span>
                                    <span style={{
                                        fontWeight: lessonPhase === 'discovery' ? 'bold' : 'normal',
                                        color: lessonPhase === 'discovery' ? 'var(--primary)' : '#666'
                                    }}>Discovery</span>
                                    <span style={{
                                        fontWeight: lessonPhase === 'application' ? 'bold' : 'normal',
                                        color: lessonPhase === 'application' ? 'var(--primary)' : '#666'
                                    }}>Application</span>
                                    <span style={{
                                        fontWeight: isExitTicketActive ? 'bold' : 'normal',
                                        color: isExitTicketActive ? 'var(--primary)' : '#666'
                                    }}>Exit Ticket</span>
                                </div>
                            </div>
                            
                            <div className="problem-container">
                                <div className="problem-card">
                                    <div className="problem-text">{currentProblem.question}</div>
                                    
                                    {(currentTopic === 'geometry' || currentTopic === 'fractions' || currentTopic === 'algebra') && lessonPhase !== 'warmup' && (
                                        <div className="visual-aid">
                                            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>
                                                Visual Guide
                                            </h3>
                                            <canvas ref={canvasRef} width="400" height="150"></canvas>
                                        </div>
                                    )}
                                    
                                    <input
                                        type="text"
                                        className="answer-input"
                                        value={userAnswer}
                                        onChange={(e) => setUserAnswer(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && !feedback?.correct && checkAnswer()}
                                        placeholder="Type your answer..."
                                        disabled={feedback?.correct}
                                    />
                                    
                                    <div style={{ marginBottom: '20px' }}>

                                    
                                        {!feedback?.correct && (

                                    
                                            <>

                                    
                                                <button className="btn-primary" onClick={checkAnswer}>

                                    
                                                    Check Answer

                                    
                                                </button>

                                    
                                                {' '}

                                    
                                                <button className="btn-hint" onClick={() => { if (!showHint) setHintUsedOnCurrentProblem(true); setShowHint(!showHint); }}>

                                    
                                                    {showHint ? 'Hide' : 'Show'} Hint

                                    
                                                </button>

                                    
                                                {' '}

                                    
                                            </>

                                    
                                        )}

                                    
                                        <button className="btn-tutor" onClick={() => setShowTutor(!showTutor)}>

                                    
                                            {showTutor ? 'Close' : 'Open'} AI Tutor

                                    
                                        </button>

                                    
                                    </div>
                                    
                                    {showHint && !feedback?.correct && (
                                        <div className="hint-box">
                                            <strong>Hint:</strong> {currentProblem.hint}
                                        </div>
                                    )}
                                    
                                    {showTutor && (
                                        <div className="chat-container">
                                            <div className="chat-header">
                                                <span style={{ fontSize: '1.5em' }}>ü§ñ</span>
                                                <strong>AI Math Tutor</strong>
                                                <button 
                                                    style={{ marginLeft: 'auto', padding: '5px 10px', fontSize: '0.8em' }}
                                                    className="btn-secondary"
                                                    onClick={() => setShowTutor(false)}
                                                >
                                                    Close
                                                </button>
                                            </div>
                                            <div className="chat-messages" ref={chatMessagesRef}>
                                                {chatMessages.length === 0 && (
                                                    <div className="chat-message assistant">
                                                        Hi! I'm your RSM math tutor. I'll help you discover the answer through guided questions - I won't just give it to you. What would you like to explore about this problem?
                                                    </div>
                                                )}
                                                {chatMessages.map((msg, idx) => (
                                                    <div key={idx} className={`chat-message ${msg.role}`}>
                                                        {msg.content}
                                                    </div>
                                                ))}
                                                {isTyping && (
                                                    <div className="typing-indicator">
                                                        <div className="typing-dots">
                                                            <div className="typing-dot"></div>
                                                            <div className="typing-dot"></div>
                                                            <div className="typing-dot"></div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            {isProblemSolved ? (
                                                <div style={{ padding: '16px', textAlign: 'center', background: '#f0fff4', borderTop: '2px solid #58cc02', borderRadius: '0 0 14px 14px' }}>
                                                    <p style={{ color: '#3a7a4e', fontWeight: 'bold', marginBottom: '12px' }}>Great work! You've solved this one.</p>
                                                    <button className="btn-primary" onClick={nextProblemInLesson}>
                                                        Next Problem ‚Üí
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="chat-input-container">
                                                    <input
                                                        type="text"
                                                        className="chat-input"
                                                        value={chatInput}
                                                        onChange={(e) => setChatInput(e.target.value)}
                                                        onKeyPress={(e) => {
                                                            if (e.key === 'Enter' && !isTyping) {
                                                                sendTutorMessage(chatInput);
                                                                setTimeout(() => e.target.focus(), 100);
                                                            }
                                                        }}
                                                        placeholder="Ask the tutor..."
                                                        disabled={isTyping}
                                                        autoFocus
                                                    />
                                                    <button
                                                        className="chat-send"
                                                        onClick={() => sendTutorMessage(chatInput)}
                                                        disabled={isTyping || !chatInput.trim()}
                                                    >
                                                        Send
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {feedback && (
                                        <div className={`feedback ${feedback.correct ? 'correct' : 'incorrect'}`}>
                                            {feedback.message}
                                            {feedback.correct && currentProblem.explanation && (
                                                <div style={{ marginTop: '15px', fontSize: '0.95em' }}>
                                                    <strong>Explanation:</strong> {currentProblem.explanation}
                                                </div>
                                            )}
                                            {feedback.correct && (
                                                <div style={{ marginTop: '20px' }}>
                                                    <button className="btn-primary" onClick={nextProblemInLesson}>
                                                        Next Problem
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderLessonComplete = () => (
                <div>
                    <div className="header">
                        <div className="header-left">
                            <h1>Lesson Complete!</h1>
                        </div>
                    </div>
                    
                    <div className="content" style={{ textAlign: 'center', padding: '60px 20px' }}>
                        <div style={{ fontSize: '5em', marginBottom: '20px' }}>üéâ</div>
                        <h2 style={{ marginBottom: '15px' }}>Great job completing {currentLesson.title}!</h2>
                        <p style={{ fontSize: '1.2em', color: '#666', marginBottom: '40px' }}>
                            You've mastered the basics. Keep practicing!
                        </p>
                        <button className="btn-primary" onClick={() => setView('home')} style={{ marginRight: '10px' }}>
                            Back to Home
                        </button>
                        <button className="btn-secondary" onClick={() => startLesson(Object.keys(LESSONS)[0])}>
                            Start Another Lesson
                        </button>
                    </div>
                </div>
            );

            const renderParentDashboard = () => {
                if (!currentUser) return null;
                const pendingChildren = users.filter(u => u.role === 'child' && u.parentId === currentUser.id && u.pendingApproval);
                const activeChildren = users.filter(u => u.role === 'child' && u.parentId === currentUser.id && !u.pendingApproval);

                return (
                    <div>
                        <div className="header">
                            <div className="header-left">
                                <h1>{currentUser.name}'s Dashboard</h1>
                                <p>Monitor your children's progress</p>
                            </div>
                        </div>

                        <div className="parent-dashboard">
                            <button className="btn-secondary" style={{ marginBottom: '24px' }}
                                onClick={() => { setCurrentUser(null); setView('login'); }}>
                                Sign Out
                            </button>

                            {pendingChildren.length > 0 && (
                                <>
                                    <h2 style={{ margin: '0 0 16px' }}>Pending Approvals</h2>
                                    {pendingChildren.map(child => (
                                        <div key={child.id} className="pending-approval-card">
                                            <div className="student-info">
                                                <div style={{ fontSize: '2.5em' }}>{child.avatar.emoji}</div>
                                                <div>
                                                    <strong>{child.name}</strong>
                                                    <div style={{ fontSize: '0.875rem', color: 'var(--text-secondary)' }}>
                                                        @{child.username}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="approve-reject-row">
                                                <button className="btn-approve" onClick={() => approveChild(child.id)}>
                                                    ‚úì Approve
                                                </button>
                                                <button className="btn-reject" onClick={() => rejectChild(child.id)}>
                                                    ‚úï Reject
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </>
                            )}

                            <h2 style={{ margin: '30px 0 20px' }}>Student Progress</h2>

                            {activeChildren.map(student => (
                                <div key={student.id} className="student-card">
                                    <div className="student-header">
                                        <div style={{ fontSize: '3em' }}>{student.avatar.emoji}</div>
                                        <div style={{ flex: 1 }}>
                                            <h3 style={{ fontSize: '1.5em', marginBottom: '5px' }}>{student.name}</h3>
                                            <p style={{ color: '#666' }}>@{student.username} ¬∑ Level {student.stats.level} ¬∑ {student.stats.xp} XP{getCurrentGrade(student) ? ` ¬∑ ${ORDINAL[getCurrentGrade(student)] ?? getCurrentGrade(student) + 'th'} Grade` : ''}</p>
                                        </div>
                                    </div>

                                    <div className="stats-grid">
                                        <div className="stat-box">
                                            <h4>Problems Solved</h4>
                                            <p>{student.stats.problemsSolved}</p>
                                        </div>
                                        <div className="stat-box">
                                            <h4>Current Streak</h4>
                                            <p>{student.stats.streak} üî•</p>
                                        </div>
                                        <div className="stat-box">
                                            <h4>Accuracy</h4>
                                            <p>{student.stats.accuracy}%</p>
                                        </div>
                                        <div className="stat-box">
                                            <h4>Total XP</h4>
                                            <p>{student.stats.xp}</p>
                                        </div>
                                    </div>

                                    <div className="skill-tree-section">
                                        {Object.entries(SKILL_TREE).map(([domain, nodes]) => (
                                            <div key={domain} className="skill-domain-block">
                                                <div className="skill-domain-label">
                                                    {({ algebra: 'üìê Algebra', geometry: 'üìè Geometry', fractions: 'üçï Fractions', ratios: '‚öñÔ∏è Ratios' })[domain]}
                                                </div>
                                                {nodes.map(node => {
                                                    const key = `${domain}.${node.id}`;
                                                    const entry = student.conceptMastery?.[key];
                                                    const level = getMasteryLevel(entry);
                                                    return (
                                                        <div key={key} className={`skill-node skill-${level}`} title={node.description}>
                                                            <span className="skill-node-name">{node.name}</span>
                                                            <span className="skill-node-count">
                                                                {entry ? `${entry.correct}/${entry.attempted}` : '‚Äî'}
                                                            </span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}

                            {activeChildren.length === 0 && pendingChildren.length === 0 && (
                                <div style={{ textAlign: 'center', padding: '60px 20px', background: 'white', borderRadius: '15px' }}>
                                    <h3 style={{ color: '#666' }}>No students yet</h3>
                                    <p style={{ color: '#999', marginTop: '10px' }}>
                                        Have your child register at the login screen using your username.
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="container">
                    {view === 'login' && renderLogin()}
                    {view === 'register-parent' && renderRegisterParent()}
                    {view === 'register-child' && renderRegisterChild()}
                    {view === 'pending-approval' && renderPendingApproval()}
                    {view === 'home' && renderHome()}
                    {view === 'problem' && renderProblem()}
                    {view === 'lesson' && renderLesson()}
                    {view === 'lessonComplete' && renderLessonComplete()}
                    {view === 'parent' && renderParentDashboard()}
                </div>
            );
        }

        ReactDOM.render(<MathLearningApp />, document.getElementById('root'));
    </script>
</body>
</html>
